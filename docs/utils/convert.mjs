import{marked as e}from"marked";import t from"isomorphic-fetch";export async function ipynb_publish(e="index"){let t=await nb2json(e),{filename:l,...r}=t.meta;try{l=l?.toLowerCase().replaceAll(" ","_")}catch(e){console.log("ERROR: ",e)}return t.meta={filename:l,...r},e=l,t}export async function nb2json(l){"undefined"!=typeof process&&(l=`http://localhost:8085/${l}.ipynb`);let r=await t(l,{headers:{"Content-Type":"application/json; charset=utf-8"}});const n=await r.json(),o=function get_metadata(e){const t={};for(const l of e.source)if(l.startsWith("#"))t.title=l.replaceAll("\n","").replaceAll("# ","",2);else if(l.startsWith(">"))t.summary=l.replaceAll("\n","").replaceAll("> ","",1);else if(l.startsWith("-")){const e=l.slice(l.indexOf("- ")+2,l.indexOf(": ")),r=l.slice(l.indexOf(": ")+2).replaceAll("\n","").trim();t[e]=r}return t}(n.cells[0]);let a=function convertNb(t,l){return t.map((t=>function cleanCell(t,l){let r;r="markdown"==t.cell_type?function processMarkdown(t){let l=!1;return t.match(/\(\(\(([^:]+)::([^)]+)\)\)\)/g)?.forEach(((e,t,r)=>{l=!0})),l&&console.log("1",{x:t}),t=t.replace(/\(\(\(([^:]+)::(.*?)\)\)\)/g,(function(t,r,n){return l=!0,console.log("KEY VALUE",{match:t,key:r,value:n}),`<aside class="${r}">${e.parse(n)}</aside>`})),l&&console.log("2",{x:t}),t=e.parse(t),l&&console.log("3",{x:t}),t=t.replace(/<li>(.*?)<\/li>/g,((e,t)=>`<li>${/<(p|div|blockquote|pre|hr|form)/.test(t)?`<div>${t}</div>`:`<p>${t}</p>`}</li>`)),t=replaceAndLog(t,/<pre><code>([\s\S]*?)<\/code><\/pre>/g,"<pre class='prettyprint'>$1</pre>"),t=replaceAndLog(t,/<a\s+(?:[^>]*?\s+)?href="(.*?)"/g,((e,t)=>(t.startsWith("./")||(e+=' onclick="window.pingServer(this)" target="_blank" rel="noopener noreferrer nofollow"'),e))),t}(t.source.join(" ")):function processCode(e,t){let l=[],r=[];if(e.source.length){let n=e.source;r=function getFlags(e){return["#collapse_input_open","#collapse_input","#collapse_output_open","#collapse_output","#hide_input","#hide_output","#hide ","%%capture","%%javascript","%%html"].filter((t=>new RegExp(t).test(e)))}(n[0]),n=function processSource(e,t){for(let l of t)e=(e=e.replaceAll(l+"\r\n","")).replaceAll(l+"\n",""),"#collapse_input_open"==l&&(e=makeDetails(e,!0)),"#collapse_input"==l&&(e=makeDetails(e,!1)),"#hide "==l&&(e=""),"#hide_input"==l&&(e=""),"%%javascript"==l&&(e=""),"%%html"==l&&(e=""),"%%capture"==l&&(e="");return e}(n.slice(1).join(" "),r),n&&l.push(t.prettify?`<pre class='prettyprint'>${n}</pre>`:n)}if(e.outputs.length)for(let t of e.outputs)l.push(processOutput(t,r));return l}(t,l);return r}(t,l)))}(n.cells.slice(1),o).flat().join(" ");o.prettify&&(a+='\n  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"><\/script>\n  <link rel="stylesheet" href="https://cdn.rawgit.com/google/code-prettify/master/styles/desert.css"/>\n  ');let p=function replaceEmojis(e){return e=(e=(e=(e=(e=(e=e.replaceAll("ðŸ™‚","&#1F642")).replaceAll("ðŸ˜³","&#128563")).replaceAll("â€ƒ","&#8195")).replaceAll("ðŸ‘·","&#128119")).replaceAll("ðŸ§¡","&#129505")).replaceAll("ðŸ’–","&#128150")}(a);return p=function convertNotes(e){let t=0;const l=/(<p)(.*?)\(\(\((.*?)\)\)\)(.*?)(<\/p>)/g,replacement=(e,l,r,n,o,a)=>{t++;let p="",s=`<label ${p} tabindex="0" for='note${t}' class='notelbl'>[${t}]</label>`,i=`<div>\n    <input type='checkbox' id='note${t}' class='notebox'>${l+p+r}\n    ${s+o+a}\n    <aside>${s} ${n} </aside> </div>\n`;return console.log({_:e,p1:l,p2:r,p3:n,p4:o,p5:a,fin:i}),i};return e.replace(l,replacement)}(p),o.filename=l.split("/")[l.split("/").length-1].replace(".ipynb",""),{meta:o,content:p}}let replaceAndLog=(e,t,l)=>e.replace(t,(function(e,t){return l.replace?.("$1",t)||l(e,t)}));function processOutput(e,t){if("error"==e.output_type)return"";if("stream"==e.output_type){if("stderr"==e.name)return"";e.data={"text/html":e.text}}const l=Object.keys(e.data);l.includes("text/html")?e=(e=e.data["text/html"]).join(""):l.includes("application/javascript")?e="<script>"+e.data["application/javascript"]+"<\/script>":l.includes("image/png")?e='<img src="data:image/png;base64,'+e.data["image/png"]+"\" alt='Image Alt Text'>":l.includes("text/plain")&&(e=/<Figure/.test(e.data["text/plain"])?"":e.data["text/plain"]);for(let l of t){try{e=(e=e.replaceAll(l+"\r\n","")).replaceAll(l+"\n","")}catch{console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!processOutput... ",typeof e,e)}"#collapse_output_open"==l&&(e=makeDetails(e,!0)),"#collapse_output"==l&&(e=makeDetails(e,!1)),"#hide_output"==l&&(e=""),"#hide "==l&&(e="")}return e}function makeDetails(e,t){return"<details "+(t?"open":"")+"> <summary>Click to toggle</summary> "+e+"</details>"}