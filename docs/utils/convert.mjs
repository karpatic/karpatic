import{marked as e}from"marked";import t from"isomorphic-fetch";import{makeDetails as l,replaceEmojis as r,convertNotes as o,replaceAndLog as n}from"./convert_util.mjs";let s=!1,p=[];export async function nb2json(i){p=[],s=!1;let c=i;"undefined"!=typeof process&&(c=`http://localhost:8085/${i}.ipynb`);let a=await t(c,{headers:{"Content-Type":"application/json; charset=utf-8"}});const u=await a.json(),f=function get_metadata(e){const t={};for(const l of e.source)if(l.startsWith("#"))t.title=l.replaceAll("\n","").replaceAll("# ","",2);else if(l.startsWith(">"))t.summary=l.replaceAll("\n","").replaceAll("> ","",1);else if(l.startsWith("-")){const e=l.slice(l.indexOf("- ")+2,l.indexOf(": ")),r=l.slice(l.indexOf(": ")+2).replaceAll("\n","").trim();t[e]=r}return t}(u.cells[0]);f.filename=i.split("/")[i.split("/").length-1].toLowerCase().replaceAll(" ","_");let d=function convertNb(t,r){return t.map((t=>function cleanCell(t,r){let i;i="markdown"==t.cell_type?function processMarkdown(t){return t=t.replace(/\(\(\((.*?)::(.*?)\)\)\)/g,(function(e,t,l){return"note"==t?e:`<aside class="${t}">${l}</aside>`})),t=e.parse(t),t=t.replace(/<li>(.*?)<\/li>/g,((e,t)=>`<li>${/<(p|div|blockquote|pre|hr|form)/.test(t)?`<div>${t}</div>`:`<p>${t}</p>`}</li>`)),t=n(t,/<pre><code>([\s\S]*?)<\/code><\/pre>/g,(()=>{s=!0})),t=n(t,/<a\s+(?:[^>]*?\s+)?href="(.*?)"/g,((e,t)=>(t.startsWith("./")||(e+=' onclick="window.pingServer(this)" target="_blank" rel="noopener noreferrer nofollow"'),e))),t=o(t),t}(t.source.join(" ")):function processCode(e,t){let r=[],o=[];if(e.source.length){let n=e.source;o=function getFlags(e){const t=["#collapse_input_open","#collapse_input","#collapse_output_open","#collapse_output","#hide_input","#hide_output","#hide","%%capture","%%javascript","%%html","#export"],l=e.split(/\s+/);return t.filter((e=>l.includes(e)))}(n[0]),o.length>0&&(n=n.slice(1)),n=function processSource(e,t,r){"#export"==t[t.length-1]&&p.push(e);for(let e of t){if(["#hide ","#hide_input","%%javascript","%%html","%%capture"].includes(e))return""}r.prettify&&(e=`<pre class='prettyprint'>${e}</pre>`);let o=t&&!!t.includes("#collapse_input_open");o&&console.log(t);for(let r of t)e=(e=e.replaceAll(r+"\r\n","")).replaceAll(r+"\n",""),"#collapse_input_open"==r?e=l(e,!0):"#collapse_input"==r&&(e=l(e,!1));return e}(n.join(" "),o,t),r.push(n)}if(e.outputs.length)for(let t of e.outputs)r.push(processOutput(t,o));return r}(t,r);return i}(t,r)))}(u.cells.slice(1),f).flat().join(" ");return console.log({pyCode:p}),f.pyCode=p,(f.prettify||s)&&(d+='\n  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"><\/script>\n  <link rel="stylesheet" href="https://cdn.rawgit.com/google/code-prettify/master/styles/desert.css"/>\n  '),{meta:f,content:r(d)}}function processOutput(e,t){if("error"==e.output_type)return"";if("stream"==e.output_type){if("stderr"==e.name)return"";e.data={"text/html":e.text}}const r=Object.keys(e.data);r.includes("text/html")?e=(e=e.data["text/html"]).join(""):r.includes("application/javascript")?e="<script>"+e.data["application/javascript"]+"<\/script>":r.includes("image/png")?e='<img src="data:image/png;base64,'+e.data["image/png"]+"\" alt='Image Alt Text'>":r.includes("text/plain")&&(e=/<Figure/.test(e.data["text/plain"])?"":e.data["text/plain"]);for(let r of t){try{e=(e=e.replaceAll(r+"\r\n","")).replaceAll(r+"\n","")}catch{console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!processOutput... ",typeof e,e)}"#collapse_output_open"==r&&(e=l(e,!0)),"#collapse_output"==r&&(e=l(e,!1)),"#hide_output"==r&&(e=""),"#hide "==r&&(e="")}return e}