import{marked as t}from"marked";import e from"isomorphic-fetch";import{makeDetails as l,replaceEmojis as r,convertNotes as o,replaceAndLog as n}from"./convert_util.mjs";let s=!1;export async function nb2json(i){s=!1;let p=i;"undefined"!=typeof process&&(p=`http://localhost:8085/${i}.ipynb`);let c=await e(p,{headers:{"Content-Type":"application/json; charset=utf-8"}});const a=await c.json(),u=function get_metadata(t){const e={};for(const l of t.source)if(l.startsWith("#"))e.title=l.replaceAll("\n","").replaceAll("# ","",2);else if(l.startsWith(">"))e.summary=l.replaceAll("\n","").replaceAll("> ","",1);else if(l.startsWith("-")){const t=l.slice(l.indexOf("- ")+2,l.indexOf(": ")),r=l.slice(l.indexOf(": ")+2).replaceAll("\n","").trim();e[t]=r}return e}(a.cells[0]);u.filename=i.split("/")[i.split("/").length-1].toLowerCase().replaceAll(" ","_");let f=function convertNb(e,r){return e.map((e=>function cleanCell(e,r){let i;i="markdown"==e.cell_type?function processMarkdown(e){return e=e.replace(/\(\(\((.*?)::(.*?)\)\)\)/g,(function(t,e,l){return"note"==e?t:`<aside class="${e}">${l}</aside>`})),e=t.parse(e),e=e.replace(/<li>(.*?)<\/li>/g,((t,e)=>`<li>${/<(p|div|blockquote|pre|hr|form)/.test(e)?`<div>${e}</div>`:`<p>${e}</p>`}</li>`)),e=n(e,/<pre><code>([\s\S]*?)<\/code><\/pre>/g,(()=>{s=!0})),e=n(e,/<a\s+(?:[^>]*?\s+)?href="(.*?)"/g,((t,e)=>(e.startsWith("./")||(t+=' onclick="window.pingServer(this)" target="_blank" rel="noopener noreferrer nofollow"'),t))),e=o(e),e}(e.source.join(" ")):function processCode(t,e){let r=[],o=[];if(t.source.length){let n=t.source;o=function getFlags(t){const e=["#collapse_input_open","#collapse_input","#collapse_output_open","#collapse_output","#hide_input","#hide_output","#hide","%%capture","%%javascript","%%html"],l=t.split(/\s+/);return e.filter((t=>l.includes(t)))}(n[0]),o.length>0&&(n=n.slice(1)),n=function processSource(t,e,r){for(let t of e){if(["#hide ","#hide_input","%%javascript","%%html","%%capture"].includes(t))return""}r.prettify&&(t=`<pre class='prettyprint'>${t}</pre>`);let o=e&&!!e.includes("#collapse_input_open");o&&console.log(e);for(let r of e)t=(t=t.replaceAll(r+"\r\n","")).replaceAll(r+"\n",""),"#collapse_input_open"==r?t=l(t,!0):"#collapse_input"==r&&(t=l(t,!1));return t}(n.join(" "),o,e),r.push(n)}if(t.outputs.length)for(let e of t.outputs)r.push(processOutput(e,o));return r}(e,r);return i}(e,r)))}(a.cells.slice(1),u).flat().join(" ");return(u.prettify||s)&&(f+='\n  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"><\/script>\n  <link rel="stylesheet" href="https://cdn.rawgit.com/google/code-prettify/master/styles/desert.css"/>\n  '),{meta:u,content:r(f)}}function processOutput(t,e){if("error"==t.output_type)return"";if("stream"==t.output_type){if("stderr"==t.name)return"";t.data={"text/html":t.text}}const r=Object.keys(t.data);r.includes("text/html")?t=(t=t.data["text/html"]).join(""):r.includes("application/javascript")?t="<script>"+t.data["application/javascript"]+"<\/script>":r.includes("image/png")?t='<img src="data:image/png;base64,'+t.data["image/png"]+"\" alt='Image Alt Text'>":r.includes("text/plain")&&(t=/<Figure/.test(t.data["text/plain"])?"":t.data["text/plain"]);for(let r of e){try{t=(t=t.replaceAll(r+"\r\n","")).replaceAll(r+"\n","")}catch{console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!processOutput... ",typeof t,t)}"#collapse_output_open"==r&&(t=l(t,!0)),"#collapse_output"==r&&(t=l(t,!1)),"#hide_output"==r&&(t=""),"#hide "==r&&(t="")}return t}