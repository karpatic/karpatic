import{marked as t}from"marked";import e from"isomorphic-fetch";import{makeDetails as r,replaceEmojis as l,convertNotes as n,replaceAndLog as o}from"./convert_util.mjs";let i=!1,p=[];export async function nb2json(s){p=[],i=!1;let a=s;"undefined"!=typeof process&&(a=`http://localhost:8085/${s}.ipynb`);let c=await e(a,{headers:{"Content-Type":"application/json; charset=utf-8"}});const u=await c.json(),f=function get_metadata(t){const e={};for(const r of t.source)if(r.startsWith("#"))e.title=r.replaceAll("\n","").replaceAll("# ","",2);else if(r.startsWith(">"))e.summary=r.replaceAll("\n","").replaceAll("> ","",1);else if(r.startsWith("-")){const t=r.slice(r.indexOf("- ")+2,r.indexOf(": ")),l=r.slice(r.indexOf(": ")+2).replaceAll("\n","").trim();e[t]=l}return e}(u.cells[0]);f.filename=s.split("/")[s.split("/").length-1].toLowerCase().replaceAll(" ","_");let d=function convertNb(e,l){return e.map((e=>function cleanCell(e,l){let s;s="markdown"==e.cell_type?function processMarkdown(e){return e=e.replace(/\(\(\((.*?)::(.*?)\)\)\)/g,(function(t,e,r){return"note"==e?t:`<aside class="${e}">${r}</aside>`})),e=t.parse(e),e=e.replace(/<li>(.*?)<\/li>/g,((t,e)=>`<li>${/<(p|div|blockquote|pre|hr|form)/.test(e)?`<div>${e}</div>`:`<p>${e}</p>`}</li>`)),e=o(e,/<pre><code>([\s\S]*?)<\/code><\/pre>/g,(()=>{i=!0})),e=o(e,/<a\s+(?:[^>]*?\s+)?href="(.*?)"/g,((t,e)=>(e.startsWith("./")||(t+=' onclick="window.pingServer(this)" target="_blank" rel="noopener noreferrer nofollow"'),t))),e=n(e),e}(e.source.join(" ")):function processCode(t,e){let l=[],n=[];if(t.source.length){let o=t.source;n=function getFlags(t){const e=["#collapse_input_open","#collapse_input","#collapse_output_open","#collapse_output","#hide_input","#hide_output","#hide","%%capture","%%javascript","%%html","#export"],r=t.split(/\s+/);return e.filter((t=>r.includes(t)))}(o[0]),n.length>0&&(o=o.slice(1)),o=function processSource(t,e,l){"#export"==e[e.length-1]&&p.push(t);for(let t of e){if(["#hide ","#hide_input","%%javascript","%%html","%%capture"].includes(t))return""}l.prettify&&(t=`<pre class='prettyprint'>${t}</pre>`);e&&e.includes("#collapse_input_open");for(let l of e)t=(t=t.replaceAll(l+"\r\n","")).replaceAll(l+"\n",""),"#collapse_input_open"==l?t=r(t,!0):"#collapse_input"==l&&(t=r(t,!1));return t}(o.join(" "),n,e),l.push(o)}if(t.outputs.length)for(let e of t.outputs)l.push(processOutput(e,n));return l}(e,l);return s}(e,l)))}(u.cells.slice(1),f).flat().join(" ");return f.pyCode=p,(f.prettify||i)&&(d+='\n  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"><\/script>\n  <link rel="stylesheet" href="https://cdn.rawgit.com/google/code-prettify/master/styles/desert.css"/>\n  '),{meta:f,content:l(d)}}function processOutput(t,e){if("error"==t.output_type)return"";if("stream"==t.output_type){if("stderr"==t.name)return"";t.data={"text/html":t.text}}const l=Object.keys(t.data);l.includes("text/html")?t=(t=t.data["text/html"]).join(""):l.includes("application/javascript")?t="<script>"+t.data["application/javascript"]+"<\/script>":l.includes("image/png")?t='<img src="data:image/png;base64,'+t.data["image/png"]+"\" alt='Image Alt Text'>":l.includes("text/plain")&&(t=/<Figure/.test(t.data["text/plain"])?"":t.data["text/plain"]);for(let l of e){try{t=(t=t.replaceAll(l+"\r\n","")).replaceAll(l+"\n","")}catch{}"#collapse_output_open"==l&&(t=r(t,!0)),"#collapse_output"==l&&(t=r(t,!1)),"#hide_output"==l&&(t=""),"#hide "==l&&(t="")}return t}