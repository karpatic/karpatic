import{marked as e}from"marked";import t from"isomorphic-fetch";import{makeDetails as r,replaceEmojis as l,convertNotes as n,replaceAndLog as o}from"./convert_util.mjs";let i=!1,s=[];export async function nb2json(p){s=[],i=!1;let c=p;"undefined"!=typeof process&&(c=`http://localhost:8085/${p}.ipynb`);let a=await t(c,{headers:{"Content-Type":"application/json; charset=utf-8"}});const u=await a.json(),d=function get_metadata(e){const t={};for(const r of e.source)if(r.startsWith("#"))t.title=r.replaceAll("\n","").replaceAll("# ","",2);else if(r.startsWith(">"))t.summary=r.replaceAll("\n","").replaceAll("> ","",1);else if(r.startsWith("-")){const e=r.slice(r.indexOf("- ")+2,r.indexOf(": ")),l=r.slice(r.indexOf(": ")+2).replaceAll("\n","").trim();t[e]=l}return t}(u.cells[0]);d.filename=p.split("/")[p.split("/").length-1].toLowerCase().replaceAll(" ","_");let f=function convertNb(t,l){return t.map((t=>function cleanCell(t,l){let p;p="markdown"==t.cell_type?function processMarkdown(t){return t=t.replace(/\(\(\((.*?)::(.*?)\)\)\)/g,(function(e,t,r){return"note"==t?e:`<aside class="${t}">${r}</aside>`})),t=e.parse(t),t=t.replace(/<li>(.*?)<\/li>/g,((e,t)=>`<li>${/<(p|div|blockquote|pre|hr|form)/.test(t)?`<div>${t}</div>`:`<p>${t}</p>`}</li>`)),t=o(t,/<pre><code>([\s\S]*?)<\/code><\/pre>/g,(()=>{i=!0})),t=o(t,/<code>([\s\S]*?)<\/code>/g,(()=>{i=!0})),t=o(t,/<a\s+(?:[^>]*?\s+)?href="(.*?)"/g,((e,t)=>(t.startsWith("./")||(e+=' onclick="window.pingServer(this)" target="_blank" rel="noopener noreferrer nofollow"'),e))),t=n(t),t}(t.source.join(" ")):function processCode(e,t){let l=[],n=[];if(e.source.length){let o=e.source;n=function getFlags(e){const t=["#collapse_input_open","#collapse_input","#collapse_output_open","#collapse_output","#hide_input","#hide_output","#hide","%%capture","%%javascript","%%html","#export"],r=e.split(/\s+/);return t.filter((e=>r.includes(e)))}(o[0]),n.length>0&&(o=o.slice(1)),o=function processSource(e,t,l){"#export"==t[t.length-1]&&s.push(e);for(let e of t){if(["#hide","#hide_input","%%javascript","%%html","%%capture"].includes(e))return""}l.prettify&&(e=`<pre class='prettyprint'>${e}</pre>`);t&&t.includes("#collapse_input_open");for(let l of t)e=(e=e.replaceAll(l+"\r\n","")).replaceAll(l+"\n",""),"#collapse_input_open"==l?e=r(e,!0):"#collapse_input"==l&&(e=r(e,!1));return e}(o.join(" "),n,t),l.push(o)}if(e.outputs.length)for(let t of e.outputs)l.push(processOutput(t,n));return l}(t,l);return p}(t,l)))}(u.cells.slice(1),d).flat().join(" ");return d.pyCode=s,(d.prettify||i)&&(f+='\n  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"><\/script>\n  <link rel="stylesheet" href="https://cdn.rawgit.com/google/code-prettify/master/styles/desert.css"/>\n  '),{meta:d,content:l(f)}}function processOutput(e,t){if("error"==e.output_type)return"";if("stream"==e.output_type){if("stderr"==e.name)return"";e.data={"text/html":e.text}}const l=Object.keys(e.data);l.includes("text/html")?e=(e=e.data["text/html"]).join(""):l.includes("application/javascript")?e="<script>"+e.data["application/javascript"]+"<\/script>":l.includes("image/png")?e='<img src="data:image/png;base64,'+e.data["image/png"]+"\" alt='Image Alt Text'>":l.includes("text/plain")&&(e=/<Figure/.test(e.data["text/plain"])?"":e.data["text/plain"]);for(let l of t){try{e=(e=e.replaceAll(l+"\r\n","")).replaceAll(l+"\n","")}catch{}"#collapse_output_open"==l&&(e=r(e,!0)),"#collapse_output"==l&&(e=r(e,!1)),"#hide_output"==l&&(e=""),"#hide"==l&&(e="")}return e}