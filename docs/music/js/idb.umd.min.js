!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).idb={})}(this,(function(e){"use strict";const t=(e,n)=>n.some((n=>e instanceof n));let n,i;const a=new WeakMap,p=new WeakMap,D=new WeakMap;let I={get(e,n,i){if(e instanceof IDBTransaction){if("done"===n)return a.get(e);if("store"===n)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return f(e[n])},set:(e,n,i)=>(e[n]=i,!0),has:(e,n)=>e instanceof IDBTransaction&&("done"===n||"store"===n)||n in e};function c(e){I=e(I)}function d(e){return"function"==typeof e?function u(e){return(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...n){return e.apply(l(this),n),f(this.request)}:function(...n){return f(e.apply(l(this),n))}}(e):(e instanceof IDBTransaction&&function(e){if(a.has(e))return;const n=new Promise(((n,i)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{n(),r()},s=()=>{i(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)}));a.set(e,n)}(e),t(e,n||(n=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,I):e)}function f(e){if(e instanceof IDBRequest)return function(e){const n=new Promise(((n,i)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{n(f(e.result)),r()},s=()=>{i(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",s)}));return D.set(n,e),n}(e);if(p.has(e))return p.get(e);const n=d(e);return n!==e&&(p.set(e,n),D.set(n,e)),n}const l=e=>D.get(e),B=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],g=new Map;function y(e,n){if(!(e instanceof IDBDatabase)||n in e||"string"!=typeof n)return;if(g.get(n))return g.get(n);const i=n.replace(/FromIndex$/,""),a=n!==i,p=b.includes(i);if(!(i in(a?IDBIndex:IDBObjectStore).prototype)||!p&&!B.includes(i))return;const s=async function(e,...n){const D=this.transaction(e,p?"readwrite":"readonly");let I=D.store;return a&&(I=I.index(n.shift())),(await Promise.all([I[i](...n),p&&D.done]))[0]};return g.set(n,s),s}c((e=>({...e,get:(n,i,a)=>y(n,i)||e.get(n,i,a),has:(n,i)=>!!y(n,i)||e.has(n,i)})));const v=["continue","continuePrimaryKey","advance"],h={},E=new WeakMap,L=new WeakMap,x={get(e,n){if(!v.includes(n))return e[n];let i=h[n];return i||(i=h[n]=function(...e){E.set(this,L.get(this)[n](...e))}),i}};async function*m(...e){let n=this;if(n instanceof IDBCursor||(n=await n.openCursor(...e)),!n)return;const i=new Proxy(n,x);for(L.set(i,n),D.set(i,l(n));n;)yield i,n=await(E.get(i)||n.continue()),E.delete(i)}function w(e,n){return n===Symbol.asyncIterator&&t(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===n&&t(e,[IDBIndex,IDBObjectStore])}c((e=>({...e,get:(n,i,a)=>w(n,i)?m:e.get(n,i,a),has:(n,i)=>w(n,i)||e.has(n,i)}))),e.deleteDB=function(e,{blocked:n}={}){const i=indexedDB.deleteDatabase(e);return n&&i.addEventListener("blocked",(e=>n(e.oldVersion,e))),f(i).then((()=>{}))},e.openDB=function(e,n,{blocked:i,upgrade:a,blocking:p,terminated:D}={}){const I=indexedDB.open(e,n),B=f(I);return a&&I.addEventListener("upgradeneeded",(e=>{a(f(I.result),e.oldVersion,e.newVersion,f(I.transaction),e)})),i&&I.addEventListener("blocked",(e=>i(e.oldVersion,e.newVersion,e))),B.then((e=>{D&&e.addEventListener("close",(()=>D())),p&&e.addEventListener("versionchange",(e=>p(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),B},e.unwrap=l,e.wrap=f}));