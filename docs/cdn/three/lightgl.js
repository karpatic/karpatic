!function(){function Texture(t,e,r){r=r||{},this.id=o.createTexture(),this.width=t,this.height=e,this.format=r.format||o.RGBA,this.type=r.type||o.UNSIGNED_BYTE,o.bindTexture(o.TEXTURE_2D,this.id),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,r.filter||r.magFilter||o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,r.filter||r.minFilter||o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,r.wrap||r.wrapS||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,r.wrap||r.wrapT||o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,this.format,t,e,0,this.format,this.type,null)}var t,e,r;function Indexer(){this.unique=[],this.indices=[],this.map={}}function Buffer(t,e){this.buffer=null,this.target=t,this.type=e,this.data=[]}function Mesh(t){t=t||{},this.vertexBuffers={},this.indexBuffers={},this.addVertexBuffer("vertices","gl_Vertex"),t.coords&&this.addVertexBuffer("coords","gl_TexCoord"),t.normals&&this.addVertexBuffer("normals","gl_Normal"),t.colors&&this.addVertexBuffer("colors","gl_Color"),"triangles"in t&&!t.triangles||this.addIndexBuffer("triangles"),t.lines&&this.addIndexBuffer("lines")}Texture.prototype={bind:function(t){o.activeTexture(o.TEXTURE0+(t||0)),o.bindTexture(o.TEXTURE_2D,this.id)},unbind:function(t){o.activeTexture(o.TEXTURE0+(t||0)),o.bindTexture(o.TEXTURE_2D,null)},drawTo:function(r,n){n=n||{};var i=o.getParameter(o.VIEWPORT);o.viewport(0,0,this.width,this.height),t=t||o.createFramebuffer(),o.bindFramebuffer(o.FRAMEBUFFER,t),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,this.id,0),!1!==n.depth&&(e=e||o.createRenderbuffer(),o.bindRenderbuffer(o.RENDERBUFFER,e),this.width==e.width&&this.height==e.height||(e.width=this.width,e.height=this.height,o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,this.width,this.height)),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,e)),r(),o.bindFramebuffer(o.FRAMEBUFFER,null),o.bindRenderbuffer(o.RENDERBUFFER,null),o.viewport(i[0],i[1],i[2],i[3])},swapWith:function(t){var e;e=t.id,t.id=this.id,this.id=e,e=t.width,t.width=this.width,this.width=e,e=t.height,t.height=this.height,this.height=e}},Texture.fromImage=function(t,e){e=e||{};var r=new Texture(t.width,t.height,e);try{o.texImage2D(o.TEXTURE_2D,0,r.format,r.format,r.type,t)}catch(t){throw"file:"==window.location.protocol?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return e.minFilter&&e.minFilter!=o.NEAREST&&e.minFilter!=o.LINEAR&&o.generateMipmap(o.TEXTURE_2D),r},Texture.fromURL=function(t,e){r=r||function(){var t=document.createElement("canvas").getContext("2d");t.canvas.width=t.canvas.height=128;for(var e=0;e<t.canvas.height;e+=16)for(var r=0;r<t.canvas.width;r+=16)t.fillStyle=16&(r^e)?"#FFF":"#DDD",t.fillRect(r,e,16,16);return t.canvas}();var n=Texture.fromImage(r,e),i=new Image,a=o;return i.onload=function(){a.makeCurrent(),Texture.fromImage(i,e).swapWith(n)},i.src=t,n},Indexer.prototype={add:function(t){var e=JSON.stringify(t);return e in this.map||(this.map[e]=this.unique.length,this.unique.push(t)),this.map[e]}},Buffer.prototype={compile:function(t){for(var e=[],r=0;r<this.data.length;r+=1e4)e=Array.prototype.concat.apply(e,this.data.slice(r,r+1e4));var n=this.data.length?e.length/this.data.length:0;if(n!=Math.round(n))throw"buffer elements not of consistent size, average size is "+n;this.buffer=this.buffer||o.createBuffer(),this.buffer.length=e.length,this.buffer.spacing=n,o.bindBuffer(this.target,this.buffer),o.bufferData(this.target,new this.type(e),t||o.STATIC_DRAW)}},Mesh.prototype={addVertexBuffer:function(t,e){(this.vertexBuffers[e]=new Buffer(o.ARRAY_BUFFER,Float32Array)).name=t,this[t]=[]},addIndexBuffer:function(t){this.indexBuffers[t]=new Buffer(o.ELEMENT_ARRAY_BUFFER,Uint16Array),this[t]=[]},compile:function(){for(var t in this.vertexBuffers){(r=this.vertexBuffers[t]).data=this[r.name],r.compile()}for(var e in this.indexBuffers){var r;(r=this.indexBuffers[e]).data=this[e],r.compile()}},transform:function(t){if(this.vertices=this.vertices.map((function(e){return t.transformPoint(Vector.fromArray(e)).toArray()})),this.normals){var e=t.inverse().transpose();this.normals=this.normals.map((function(t){return e.transformVector(Vector.fromArray(t)).unit().toArray()}))}return this.compile(),this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var t=0;t<this.vertices.length;t++)this.normals[t]=new Vector;for(t=0;t<this.triangles.length;t++){var e=this.triangles[t],r=Vector.fromArray(this.vertices[e[0]]),n=Vector.fromArray(this.vertices[e[1]]),o=Vector.fromArray(this.vertices[e[2]]),i=n.subtract(r).cross(o.subtract(r)).unit();this.normals[e[0]]=this.normals[e[0]].add(i),this.normals[e[1]]=this.normals[e[1]].add(i),this.normals[e[2]]=this.normals[e[2]].add(i)}for(t=0;t<this.vertices.length;t++)this.normals[t]=this.normals[t].unit().toArray();return this.compile(),this},computeWireframe:function(){for(var t=new Indexer,e=0;e<this.triangles.length;e++)for(var r=this.triangles[e],n=0;n<r.length;n++){var o=r[n],i=r[(n+1)%r.length];t.add([Math.min(o,i),Math.max(o,i)])}return this.lines||this.addIndexBuffer("lines"),this.lines=t.unique,this.compile(),this},getAABB:function(){var t={min:new Vector(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};t.max=t.min.negative();for(var e=0;e<this.vertices.length;e++){var r=Vector.fromArray(this.vertices[e]);t.min=Vector.min(t.min,r),t.max=Vector.max(t.max,r)}return t},getBoundingSphere:function(){for(var t=this.getAABB(),e={center:t.min.add(t.max).divide(2),radius:0},r=0;r<this.vertices.length;r++)e.radius=Math.max(e.radius,Vector.fromArray(this.vertices[r]).subtract(e.center).length());return e}},Mesh.plane=function(t){for(var e=new Mesh(t=t||{}),r=t.detailX||t.detail||1,n=t.detailY||t.detail||1,o=0;o<=n;o++)for(var i=o/n,a=0;a<=r;a++){var s=a/r;if(e.vertices.push([2*s-1,2*i-1,0]),e.coords&&e.coords.push([s,i]),e.normals&&e.normals.push([0,0,1]),a<r&&o<n){var u=a+o*(r+1);e.triangles.push([u,u+1,u+r+1]),e.triangles.push([u+r+1,u+1,u+r+2])}}return e.compile(),e};var n=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];function pickOctant(t){return new Vector(2*(1&t)-1,(2&t)-1,(4&t)/2-1)}function Vector(t,e,r){this.x=t||0,this.y=e||0,this.z=r||0}function regexMap(t,e,r){for(var n;null!==(n=t.exec(e));)r(n)}Mesh.cube=function(t){for(var e=new Mesh(t),r=0;r<n.length;r++){for(var o=n[r],i=4*r,a=0;a<4;a++){var s=o[a];e.vertices.push(pickOctant(s).toArray()),e.coords&&e.coords.push([1&a,(2&a)/2]),e.normals&&e.normals.push(o.slice(4,7))}e.triangles.push([i,i+1,i+2]),e.triangles.push([i+2,i+1,i+3])}return e.compile(),e},Mesh.sphere=function(t){function tri(t,e,r){return a?[t,r,e]:[t,e,r]}function fix(t){return t+(t-t*t)/2}for(var e=new Mesh(t=t||{}),r=new Indexer,n=t.detail||6,o=0;o<8;o++)for(var i=pickOctant(o),a=i.x*i.y*i.z>0,s=[],u=0;u<=n;u++){for(var c=0;u+c<=n;c++){var h=c/n,f=(n-u-c)/n,m={vertex:new Vector(fix(l=u/n),fix(h),fix(f)).unit().multiply(i).toArray()};e.coords&&(m.coord=i.y>0?[1-l,f]:[f,1-l]),s.push(r.add(m))}if(u>0)for(c=0;u+c<=n;c++){var l=(u-1)*(n+1)+(u-1-(u-1)*(u-1))/2+c;h=u*(n+1)+(u-u*u)/2+c;e.triangles.push(tri(s[l],s[l+1],s[h])),u+c<n&&e.triangles.push(tri(s[h],s[l+1],s[h+1]))}}return e.vertices=r.unique.map((function(t){return t.vertex})),e.coords&&(e.coords=r.unique.map((function(t){return t.coord}))),e.normals&&(e.normals=e.vertices),e.compile(),e},Mesh.load=function(t,e){"coords"in(e=e||{})||(e.coords=!!t.coords),"normals"in e||(e.normals=!!t.normals),"colors"in e||(e.colors=!!t.colors),"triangles"in e||(e.triangles=!!t.triangles),"lines"in e||(e.lines=!!t.lines);var r=new Mesh(e);return r.vertices=t.vertices,r.coords&&(r.coords=t.coords),r.normals&&(r.normals=t.normals),r.colors&&(r.colors=t.colors),r.triangles&&(r.triangles=t.triangles),r.lines&&(r.lines=t.lines),r.compile(),r},Vector.prototype={negative:function(){return new Vector(-this.x,-this.y,-this.z)},add:function(t){return t instanceof Vector?new Vector(this.x+t.x,this.y+t.y,this.z+t.z):new Vector(this.x+t,this.y+t,this.z+t)},subtract:function(t){return t instanceof Vector?new Vector(this.x-t.x,this.y-t.y,this.z-t.z):new Vector(this.x-t,this.y-t,this.z-t)},multiply:function(t){return t instanceof Vector?new Vector(this.x*t.x,this.y*t.y,this.z*t.z):new Vector(this.x*t,this.y*t,this.z*t)},divide:function(t){return t instanceof Vector?new Vector(this.x/t.x,this.y/t.y,this.z/t.z):new Vector(this.x/t,this.y/t,this.z/t)},equals:function(t){return this.x==t.x&&this.y==t.y&&this.z==t.z},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){return new Vector(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(t){return[this.x,this.y,this.z].slice(0,t||3)},clone:function(){return new Vector(this.x,this.y,this.z)},init:function(t,e,r){return this.x=t,this.y=e,this.z=r,this}},Vector.negative=function(t,e){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},Vector.add=function(t,e,r){return e instanceof Vector?(r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z):(r.x=t.x+e,r.y=t.y+e,r.z=t.z+e),r},Vector.subtract=function(t,e,r){return e instanceof Vector?(r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z):(r.x=t.x-e,r.y=t.y-e,r.z=t.z-e),r},Vector.multiply=function(t,e,r){return e instanceof Vector?(r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z):(r.x=t.x*e,r.y=t.y*e,r.z=t.z*e),r},Vector.divide=function(t,e,r){return e instanceof Vector?(r.x=t.x/e.x,r.y=t.y/e.y,r.z=t.z/e.z):(r.x=t.x/e,r.y=t.y/e,r.z=t.z/e),r},Vector.cross=function(t,e,r){return r.x=t.y*e.z-t.z*e.y,r.y=t.z*e.x-t.x*e.z,r.z=t.x*e.y-t.y*e.x,r},Vector.unit=function(t,e){var r=t.length();return e.x=t.x/r,e.y=t.y/r,e.z=t.z/r,e},Vector.fromAngles=function(t,e){return new Vector(Math.cos(t)*Math.cos(e),Math.sin(e),Math.sin(t)*Math.cos(e))},Vector.randomDirection=function(){return Vector.fromAngles(Math.random()*Math.PI*2,Math.asin(2*Math.random()-1))},Vector.min=function(t,e){return new Vector(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.min(t.z,e.z))},Vector.max=function(t,e){return new Vector(Math.max(t.x,e.x),Math.max(t.y,e.y),Math.max(t.z,e.z))},Vector.lerp=function(t,e,r){return e.subtract(t).multiply(r).add(t)},Vector.fromArray=function(t){return new Vector(t[0],t[1],t[2])};var o,i="LIGHTGL";function Shader(t,e){function followScriptTagById(t){var e=document.getElementById(t);return e?e.text:t}var r="    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",n=r+"    attribute vec4 gl_Vertex;    attribute vec4 gl_TexCoord;    attribute vec3 gl_Normal;    attribute vec4 gl_Color;    vec4 ftransform() {      return gl_ModelViewProjectionMatrix * gl_Vertex;    }  ",a="    precision highp float;  "+r,s=(t=followScriptTagById(t))+(e=followScriptTagById(e)),u={};function fix(t,e){var r={},n=/^((\s*\/\/.*\n|\s*#extension.*\n)+)\^*$/.exec(e);return e=n?n[1]+t+e.substr(n[1].length):t+e,regexMap(/\bgl_\w+\b/g,t,(function(t){t in r||(e=e.replace(new RegExp("\\b"+t+"\\b","g"),i+t),r[t]=!0)})),e}function compileSource(t,e){var r=o.createShader(t);if(o.shaderSource(r,e),o.compileShader(r),!o.getShaderParameter(r,o.COMPILE_STATUS))throw"compile error: "+o.getShaderInfoLog(r);return r}if(regexMap(/\b(gl_[^;]*)\b;/g,r,(function(t){var e=t[1];if(-1!=s.indexOf(e)){var r=e.replace(/[a-z_]/g,"");u[r]=i+e}})),-1!=s.indexOf("ftransform")&&(u.MVPM=i+"gl_ModelViewProjectionMatrix"),this.usedMatrices=u,t=fix(n,t),e=fix(a,e),this.program=o.createProgram(),o.attachShader(this.program,compileSource(o.VERTEX_SHADER,t)),o.attachShader(this.program,compileSource(o.FRAGMENT_SHADER,e)),o.linkProgram(this.program),!o.getProgramParameter(this.program,o.LINK_STATUS))throw"link error: "+o.getProgramInfoLog(this.program);this.attributes={},this.uniformLocations={};var c={};regexMap(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,t+e,(function(t){c[t[2]]=1})),this.isSampler=c}function isNumber(t){var e=Object.prototype.toString.call(t);return"[object Number]"==e||"[object Boolean]"==e}Shader.prototype={uniforms:function(t){for(var e in o.useProgram(this.program),t){var r=this.uniformLocations[e]||o.getUniformLocation(this.program,e);if(r){this.uniformLocations[e]=r;var n=t[e];if(n instanceof Vector?n=[n.x,n.y,n.z]:n instanceof Matrix&&(n=n.m),i=n,a=void 0,"[object Array]"==(a=Object.prototype.toString.call(i))||"[object Float32Array]"==a)switch(n.length){case 1:o.uniform1fv(r,new Float32Array(n));break;case 2:o.uniform2fv(r,new Float32Array(n));break;case 3:o.uniform3fv(r,new Float32Array(n));break;case 4:o.uniform4fv(r,new Float32Array(n));break;case 9:o.uniformMatrix3fv(r,!1,new Float32Array([n[0],n[3],n[6],n[1],n[4],n[7],n[2],n[5],n[8]]));break;case 16:o.uniformMatrix4fv(r,!1,new Float32Array([n[0],n[4],n[8],n[12],n[1],n[5],n[9],n[13],n[2],n[6],n[10],n[14],n[3],n[7],n[11],n[15]]));break;default:throw"don't know how to load uniform \""+e+'" of length '+n.length}else{if(!isNumber(n))throw'attempted to set uniform "'+e+'" to invalid value '+n;(this.isSampler[e]?o.uniform1i:o.uniform1f).call(o,r,n)}}}var i,a;return this},draw:function(t,e){this.drawBuffers(t.vertexBuffers,t.indexBuffers[e==o.LINES?"lines":"triangles"],arguments.length<2?o.TRIANGLES:e)},drawBuffers:function(t,e,r){var n=this.usedMatrices,a=o.modelviewMatrix,s=o.projectionMatrix,u=n.MVMI||n.NM?a.inverse():null,c=n.PMI?s.inverse():null,h=n.MVPM||n.MVPMI?s.multiply(a):null,f={};if(n.MVM&&(f[n.MVM]=a),n.MVMI&&(f[n.MVMI]=u),n.PM&&(f[n.PM]=s),n.PMI&&(f[n.PMI]=c),n.MVPM&&(f[n.MVPM]=h),n.MVPMI&&(f[n.MVPMI]=h.inverse()),n.NM){var m=u.m;f[n.NM]=[m[0],m[4],m[8],m[1],m[5],m[9],m[2],m[6],m[10]]}this.uniforms(f);var l=0;for(var d in t){var v=t[d],x=this.attributes[d]||o.getAttribLocation(this.program,d.replace(/^(gl_.*)$/,i+"$1"));-1!=x&&v.buffer&&(this.attributes[d]=x,o.bindBuffer(o.ARRAY_BUFFER,v.buffer),o.enableVertexAttribArray(x),o.vertexAttribPointer(x,v.buffer.spacing,o.FLOAT,!1,0,0),l=v.buffer.length/v.buffer.spacing)}for(var d in this.attributes)d in t||o.disableVertexAttribArray(this.attributes[d]);return!l||e&&!e.buffer||(e?(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e.buffer),o.drawElements(r,e.buffer.length,o.UNSIGNED_SHORT,0)):o.drawArrays(r,0,l)),this}},Shader.fromURL=function(t,e){var XMLHttpRequestGet=function(t){var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(null),200!==e.status)throw"could not load "+t;return e.responseText};return new Shader(XMLHttpRequestGet(t),XMLHttpRequestGet(e))},Shader.from=function(t,e){try{return new Shader(t,e)}catch(r){return Shader.fromURL(t,e)}};var a={create:function(t){var e=(t=t||{}).canvas;e||((e=document.createElement("canvas")).width=t.width||800,e.height=t.height||600),"alpha"in t||(t.alpha=!1);try{o=e.getContext("webgl",t)}catch(t){}try{o=o||e.getContext("experimental-webgl",t)}catch(t){}if(!o)throw"WebGL not supported";return function addMatrixStack(){o.MODELVIEW=1|s,o.PROJECTION=2|s;var t=new Matrix,e=new Matrix;o.modelviewMatrix=new Matrix,o.projectionMatrix=new Matrix;var r,n,i=[],a=[];o.matrixMode=function(t){switch(t){case o.MODELVIEW:r="modelviewMatrix",n=i;break;case o.PROJECTION:r="projectionMatrix",n=a;break;default:throw"invalid matrix mode "+t}},o.loadIdentity=function(){Matrix.identity(o[r])},o.loadMatrix=function(t){for(var e=t.m,n=o[r].m,i=0;i<16;i++)n[i]=e[i]},o.multMatrix=function(t){o.loadMatrix(Matrix.multiply(o[r],t,e))},o.perspective=function(e,r,n,i){o.multMatrix(Matrix.perspective(e,r,n,i,t))},o.frustum=function(e,r,n,i,a,s){o.multMatrix(Matrix.frustum(e,r,n,i,a,s,t))},o.ortho=function(e,r,n,i,a,s){o.multMatrix(Matrix.ortho(e,r,n,i,a,s,t))},o.scale=function(e,r,n){o.multMatrix(Matrix.scale(e,r,n,t))},o.translate=function(e,r,n){o.multMatrix(Matrix.translate(e,r,n,t))},o.rotate=function(e,r,n,i){o.multMatrix(Matrix.rotate(e,r,n,i,t))},o.lookAt=function(e,r,n,i,a,s,u,c,h){o.multMatrix(Matrix.lookAt(e,r,n,i,a,s,u,c,h,t))},o.pushMatrix=function(){n.push(Array.prototype.slice.call(o[r].m))},o.popMatrix=function(){var t=n.pop();o[r].m=u?new Float32Array(t):t},o.project=function(t,e,r,n,i,a){n=n||o.modelviewMatrix,i=i||o.projectionMatrix,a=a||o.getParameter(o.VIEWPORT);var s=i.transformPoint(n.transformPoint(new Vector(t,e,r)));return new Vector(a[0]+a[2]*(.5*s.x+.5),a[1]+a[3]*(.5*s.y+.5),.5*s.z+.5)},o.unProject=function(r,n,i,a,s,u){a=a||o.modelviewMatrix,s=s||o.projectionMatrix;var c=new Vector((r-(u=u||o.getParameter(o.VIEWPORT))[0])/u[2]*2-1,(n-u[1])/u[3]*2-1,2*i-1);return Matrix.inverse(Matrix.multiply(s,a,t),e).transformPoint(c)},o.matrixMode(o.MODELVIEW)}(),function addImmediateMode(){var t={mesh:new Mesh({coords:!0,colors:!0,triangles:!1}),mode:-1,coord:[0,0,0,0],color:[1,1,1,1],pointSize:1,shader:new Shader("      uniform float pointSize;      varying vec4 color;      varying vec4 coord;      void main() {        color = gl_Color;        coord = gl_TexCoord;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;        gl_PointSize = pointSize;      }    ","      uniform sampler2D texture;      uniform float pointSize;      uniform bool useTexture;      varying vec4 color;      varying vec4 coord;      void main() {        gl_FragColor = color;        if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);      }    ")};o.pointSize=function(e){t.shader.uniforms({pointSize:e})},o.begin=function(e){if(-1!=t.mode)throw"mismatched gl.begin() and gl.end() calls";t.mode=e,t.mesh.colors=[],t.mesh.coords=[],t.mesh.vertices=[]},o.color=function(e,r,n,o){t.color=1==arguments.length?e.toArray().concat(1):[e,r,n,o||1]},o.texCoord=function(e,r){t.coord=1==arguments.length?e.toArray(2):[e,r]},o.vertex=function(e,r,n){t.mesh.colors.push(t.color),t.mesh.coords.push(t.coord),t.mesh.vertices.push(1==arguments.length?e.toArray():[e,r,n])},o.end=function(){if(-1==t.mode)throw"mismatched gl.begin() and gl.end() calls";t.mesh.compile(),t.shader.uniforms({useTexture:!!o.getParameter(o.TEXTURE_BINDING_2D)}).draw(t.mesh,t.mode),t.mode=-1}}(),function addEventListeners(){var t=o,e=0,r=0,n={},i=!1,a=Object.prototype.hasOwnProperty;function isDragging(){for(var t in n)if(a.call(n,t)&&n[t])return!0;return!1}function augment(t){var n={};for(var a in t)"function"==typeof t[a]?n[a]=function(e){return function(){e.apply(t,arguments)}}(t[a]):n[a]=t[a];n.original=t,n.x=n.pageX,n.y=n.pageY;for(var s=o.canvas;s;s=s.offsetParent)n.x-=s.offsetLeft,n.y-=s.offsetTop;return i?(n.deltaX=n.x-e,n.deltaY=n.y-r):(n.deltaX=0,n.deltaY=0,i=!0),e=n.x,r=n.y,n.dragging=isDragging(),n.preventDefault=function(){n.original.preventDefault()},n.stopPropagation=function(){n.original.stopPropagation()},n}function augmentTouchEvent(t){var n={};for(var a in t)"function"==typeof t[a]?n[a]=function(e){return function(){e.apply(t,arguments)}}(t[a]):n[a]=t[a];if(n.original=t,n.targetTouches.length>0){var s=n.targetTouches[0];n.x=s.pageX,n.y=s.pageY;for(var u=o.canvas;u;u=u.offsetParent)n.x-=u.offsetLeft,n.y-=u.offsetTop;i?(n.deltaX=n.x-e,n.deltaY=n.y-r):(n.deltaX=0,n.deltaY=0,i=!0),e=n.x,r=n.y,n.dragging=!0}return n.preventDefault=function(){n.original.preventDefault()},n.stopPropagation=function(){n.original.stopPropagation()},n}function mousedown(e){o=t,isDragging()||(on(document,"mousemove",mousemove),on(document,"mouseup",mouseup),off(o.canvas,"mousemove",mousemove),off(o.canvas,"mouseup",mouseup)),n[e.which]=!0,e=augment(e),o.onmousedown&&o.onmousedown(e),e.preventDefault()}function mousemove(e){o=t,e=augment(e),o.onmousemove&&o.onmousemove(e),e.preventDefault()}function mouseup(e){o=t,n[e.which]=!1,isDragging()||(off(document,"mousemove",mousemove),off(document,"mouseup",mouseup),on(o.canvas,"mousemove",mousemove),on(o.canvas,"mouseup",mouseup)),e=augment(e),o.onmouseup&&o.onmouseup(e),e.preventDefault()}function mousewheel(e){o=t,e=augment(e),o.onmousewheel&&o.onmousewheel(e),e.preventDefault()}function touchstart(e){resetAll(),on(document,"touchmove",touchmove),on(document,"touchend",touchend),off(o.canvas,"touchmove",touchmove),off(o.canvas,"touchend",touchend),o=t,e=augmentTouchEvent(e),o.ontouchstart&&o.ontouchstart(e),e.preventDefault()}function touchmove(e){o=t,0===e.targetTouches.length&&touchend(e),e=augmentTouchEvent(e),o.ontouchmove&&o.ontouchmove(e),e.preventDefault()}function touchend(e){off(document,"touchmove",touchmove),off(document,"touchend",touchend),on(o.canvas,"touchmove",touchmove),on(o.canvas,"touchend",touchend),o=t,e=augmentTouchEvent(e),o.ontouchend&&o.ontouchend(e),e.preventDefault()}function reset(){i=!1}function resetAll(){n={},i=!1}on(o.canvas,"mousedown",mousedown),on(o.canvas,"mousemove",mousemove),on(o.canvas,"mouseup",mouseup),on(o.canvas,"mousewheel",mousewheel),on(o.canvas,"DOMMouseScroll",mousewheel),on(o.canvas,"mouseover",reset),on(o.canvas,"mouseout",reset),on(o.canvas,"touchstart",touchstart),on(o.canvas,"touchmove",touchmove),on(o.canvas,"touchend",touchend),on(document,"contextmenu",resetAll)}(),function addOtherMethods(){t=o,o.makeCurrent=function(){o=t},o.animate=function(){var t=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){setTimeout(t,1e3/60)},e=(new Date).getTime(),r=o;function update(){o=r;var n=(new Date).getTime();o.onupdate&&o.onupdate((n-e)/1e3),o.ondraw&&o.ondraw(),t(update),e=n}update()},o.fullscreen=function(t){var e=(t=t||{}).paddingTop||0,r=t.paddingLeft||0,n=t.paddingRight||0,i=t.paddingBottom||0;if(!document.body)throw"document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)";function resize(){o.canvas.width=window.innerWidth-r-n,o.canvas.height=window.innerHeight-e-i,o.viewport(0,0,o.canvas.width,o.canvas.height),!t.camera&&"camera"in t||(o.matrixMode(o.PROJECTION),o.loadIdentity(),o.perspective(t.fov||45,o.canvas.width/o.canvas.height,t.near||.1,t.far||1e3),o.matrixMode(o.MODELVIEW)),o.onresize&&o.onresize(),o.ondraw&&o.ondraw()}document.body.appendChild(o.canvas),document.body.style.overflow="hidden",o.canvas.style.position="absolute",o.canvas.style.left=r+"px",o.canvas.style.top=e+"px",on(window,"resize",resize),resize()};var t}(),o},keys:{},Matrix:Matrix,Indexer:Indexer,Buffer:Buffer,Mesh:Mesh,HitTest:HitTest,Raytracer:Raytracer,Shader:Shader,Texture:Texture,Vector:Vector};function mapKeyCode(t){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[t]||(t>=65&&t<=90?String.fromCharCode(t):null)}function on(t,e,r){t.addEventListener(e,r)}function off(t,e,r){t.removeEventListener(e,r)}on(document,"keydown",(function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var e=mapKeyCode(t.keyCode);e&&(a.keys[e]=!0),a.keys[t.keyCode]=!0}})),on(document,"keyup",(function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var e=mapKeyCode(t.keyCode);e&&(a.keys[e]=!1),a.keys[t.keyCode]=!1}}));var s=305397760,u="undefined"!=typeof Float32Array;function Matrix(){var t=Array.prototype.concat.apply([],arguments);t.length||(t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.m=u?new Float32Array(t):t}function HitTest(t,e,r){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=e,this.normal=r}function Raytracer(){var t=o.getParameter(o.VIEWPORT),e=o.modelviewMatrix.m,r=new Vector(e[0],e[4],e[8]),n=new Vector(e[1],e[5],e[9]),i=new Vector(e[2],e[6],e[10]),a=new Vector(e[3],e[7],e[11]);this.eye=new Vector(-a.dot(r),-a.dot(n),-a.dot(i));var s=t[0],u=s+t[2],c=t[1],h=c+t[3];this.ray00=o.unProject(s,c,1).subtract(this.eye),this.ray10=o.unProject(u,c,1).subtract(this.eye),this.ray01=o.unProject(s,h,1).subtract(this.eye),this.ray11=o.unProject(u,h,1).subtract(this.eye),this.viewport=t}Matrix.prototype={inverse:function(){return Matrix.inverse(this,new Matrix)},transpose:function(){return Matrix.transpose(this,new Matrix)},multiply:function(t){return Matrix.multiply(this,t,new Matrix)},transformPoint:function(t){var e=this.m;return new Vector(e[0]*t.x+e[1]*t.y+e[2]*t.z+e[3],e[4]*t.x+e[5]*t.y+e[6]*t.z+e[7],e[8]*t.x+e[9]*t.y+e[10]*t.z+e[11]).divide(e[12]*t.x+e[13]*t.y+e[14]*t.z+e[15])},transformVector:function(t){var e=this.m;return new Vector(e[0]*t.x+e[1]*t.y+e[2]*t.z,e[4]*t.x+e[5]*t.y+e[6]*t.z,e[8]*t.x+e[9]*t.y+e[10]*t.z)}},Matrix.inverse=function(t,e){e=e||new Matrix;var r=t.m,n=e.m;n[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],n[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],n[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],n[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],n[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],n[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],n[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],n[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],n[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],n[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],n[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],n[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],n[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],n[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],n[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],n[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];for(var o=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+r[3]*n[12],i=0;i<16;i++)n[i]/=o;return e},Matrix.transpose=function(t,e){e=e||new Matrix;var r=t.m,n=e.m;return n[0]=r[0],n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=r[1],n[5]=r[5],n[6]=r[9],n[7]=r[13],n[8]=r[2],n[9]=r[6],n[10]=r[10],n[11]=r[14],n[12]=r[3],n[13]=r[7],n[14]=r[11],n[15]=r[15],e},Matrix.multiply=function(t,e,r){r=r||new Matrix;var n=t.m,o=e.m,i=r.m;return i[0]=n[0]*o[0]+n[1]*o[4]+n[2]*o[8]+n[3]*o[12],i[1]=n[0]*o[1]+n[1]*o[5]+n[2]*o[9]+n[3]*o[13],i[2]=n[0]*o[2]+n[1]*o[6]+n[2]*o[10]+n[3]*o[14],i[3]=n[0]*o[3]+n[1]*o[7]+n[2]*o[11]+n[3]*o[15],i[4]=n[4]*o[0]+n[5]*o[4]+n[6]*o[8]+n[7]*o[12],i[5]=n[4]*o[1]+n[5]*o[5]+n[6]*o[9]+n[7]*o[13],i[6]=n[4]*o[2]+n[5]*o[6]+n[6]*o[10]+n[7]*o[14],i[7]=n[4]*o[3]+n[5]*o[7]+n[6]*o[11]+n[7]*o[15],i[8]=n[8]*o[0]+n[9]*o[4]+n[10]*o[8]+n[11]*o[12],i[9]=n[8]*o[1]+n[9]*o[5]+n[10]*o[9]+n[11]*o[13],i[10]=n[8]*o[2]+n[9]*o[6]+n[10]*o[10]+n[11]*o[14],i[11]=n[8]*o[3]+n[9]*o[7]+n[10]*o[11]+n[11]*o[15],i[12]=n[12]*o[0]+n[13]*o[4]+n[14]*o[8]+n[15]*o[12],i[13]=n[12]*o[1]+n[13]*o[5]+n[14]*o[9]+n[15]*o[13],i[14]=n[12]*o[2]+n[13]*o[6]+n[14]*o[10]+n[15]*o[14],i[15]=n[12]*o[3]+n[13]*o[7]+n[14]*o[11]+n[15]*o[15],r},Matrix.identity=function(t){var e=(t=t||new Matrix).m;return e[0]=e[5]=e[10]=e[15]=1,e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,t},Matrix.perspective=function(t,e,r,n,o){var i=Math.tan(t*Math.PI/360)*r,a=i*e;return Matrix.frustum(-a,a,-i,i,r,n,o)},Matrix.frustum=function(t,e,r,n,o,i,a){var s=(a=a||new Matrix).m;return s[0]=2*o/(e-t),s[1]=0,s[2]=(e+t)/(e-t),s[3]=0,s[4]=0,s[5]=2*o/(n-r),s[6]=(n+r)/(n-r),s[7]=0,s[8]=0,s[9]=0,s[10]=-(i+o)/(i-o),s[11]=-2*i*o/(i-o),s[12]=0,s[13]=0,s[14]=-1,s[15]=0,a},Matrix.ortho=function(t,e,r,n,o,i,a){var s=(a=a||new Matrix).m;return s[0]=2/(e-t),s[1]=0,s[2]=0,s[3]=-(e+t)/(e-t),s[4]=0,s[5]=2/(n-r),s[6]=0,s[7]=-(n+r)/(n-r),s[8]=0,s[9]=0,s[10]=-2/(i-o),s[11]=-(i+o)/(i-o),s[12]=0,s[13]=0,s[14]=0,s[15]=1,a},Matrix.scale=function(t,e,r,n){var o=(n=n||new Matrix).m;return o[0]=t,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=e,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,n},Matrix.translate=function(t,e,r,n){var o=(n=n||new Matrix).m;return o[0]=1,o[1]=0,o[2]=0,o[3]=t,o[4]=0,o[5]=1,o[6]=0,o[7]=e,o[8]=0,o[9]=0,o[10]=1,o[11]=r,o[12]=0,o[13]=0,o[14]=0,o[15]=1,n},Matrix.rotate=function(t,e,r,n,o){if(!t||!e&&!r&&!n)return Matrix.identity(o);var i=(o=o||new Matrix).m,a=Math.sqrt(e*e+r*r+n*n);t*=Math.PI/180,e/=a,r/=a,n/=a;var s=Math.cos(t),u=Math.sin(t),c=1-s;return i[0]=e*e*c+s,i[1]=e*r*c-n*u,i[2]=e*n*c+r*u,i[3]=0,i[4]=r*e*c+n*u,i[5]=r*r*c+s,i[6]=r*n*c-e*u,i[7]=0,i[8]=n*e*c-r*u,i[9]=n*r*c+e*u,i[10]=n*n*c+s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,o},Matrix.lookAt=function(t,e,r,n,o,i,a,s,u,c){var h=(c=c||new Matrix).m,f=new Vector(t,e,r),m=new Vector(n,o,i),l=new Vector(a,s,u),d=f.subtract(m).unit(),v=l.cross(d).unit(),x=d.cross(v).unit();return h[0]=v.x,h[1]=v.y,h[2]=v.z,h[3]=-v.dot(f),h[4]=x.x,h[5]=x.y,h[6]=x.z,h[7]=-x.dot(f),h[8]=d.x,h[9]=d.y,h[10]=d.z,h[11]=-d.dot(f),h[12]=0,h[13]=0,h[14]=0,h[15]=1,c},HitTest.prototype={mergeWith:function(t){t.t>0&&t.t<this.t&&(this.t=t.t,this.hit=t.hit,this.normal=t.normal)}},Raytracer.prototype={getRayForPixel:function(t,e){t=(t-this.viewport[0])/this.viewport[2],e=1-(e-this.viewport[1])/this.viewport[3];var r=Vector.lerp(this.ray00,this.ray10,t),n=Vector.lerp(this.ray01,this.ray11,t);return Vector.lerp(r,n,e).unit()}},Raytracer.hitTestBox=function(t,e,r,n){var o=r.subtract(t).divide(e),i=n.subtract(t).divide(e),a=Vector.min(o,i),s=Vector.max(o,i),u=a.max(),c=s.min();if(u>0&&u<c){var h=1e-6,f=t.add(e.multiply(u));return r=r.add(h),n=n.subtract(h),new HitTest(u,f,new Vector((f.x>n.x)-(f.x<r.x),(f.y>n.y)-(f.y<r.y),(f.z>n.z)-(f.z<r.z)))}return null},Raytracer.hitTestSphere=function(t,e,r,n){var o=t.subtract(r),i=e.dot(e),a=2*e.dot(o),s=a*a-4*i*(o.dot(o)-n*n);if(s>0){var u=(-a-Math.sqrt(s))/(2*i),c=t.add(e.multiply(u));return new HitTest(u,c,c.subtract(r).divide(n))}return null},Raytracer.hitTestTriangle=function(t,e,r,n,o){var i=n.subtract(r),a=o.subtract(r),s=i.cross(a).unit(),u=s.dot(r.subtract(t))/s.dot(e);if(u>0){var c=t.add(e.multiply(u)),h=c.subtract(r),f=a.dot(a),m=a.dot(i),l=a.dot(h),d=i.dot(i),v=i.dot(h),x=f*d-m*m,p=(d*l-m*v)/x,g=(f*v-m*l)/x;if(p>=0&&g>=0&&p+g<=1)return new HitTest(u,c,s)}return null}}();