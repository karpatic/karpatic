!function(e){function fnNumberSort(e,t){return e-t}var CSG=function(){this.polygons=[],this.properties=new CSG.Properties,this.isCanonicalized=!0,this.isRetesselated=!0};function insertSorted(e,t,n){for(var r=0,o=e.length;o>r;){var i=Math.floor((r+o)/2);n(t,e[i])>0?r=i+1:o=i}e.splice(r,0,t)}CSG.defaultResolution2D=32,CSG.defaultResolution3D=12,CSG.fromPolygons=function(e){var t=new CSG;return t.polygons=e,t.isCanonicalized=!1,t.isRetesselated=!1,t},CSG.fromObject=function(e){var t=e.polygons.map((function(e){return CSG.Polygon.fromObject(e)})),n=CSG.fromPolygons(t);return n=n.canonicalized()},CSG.fromCompactBinary=function(e){if("CSG"!=e.class)throw new Error("Not a CSG");for(var t,n,r,o,i,s,a=[],l=e.planeData,u=l.length/4,h=0,p=0;p<u;p++)t=l[h++],n=l[h++],r=l[h++],o=l[h++],i=new CSG.Vector3D(t,n,r),s=new CSG.Plane(i,o),a.push(s);var c,f,m=[],d=e.vertexData,v=d.length/3;h=0;for(var g=0;g<v;g++)t=d[h++],n=d[h++],r=d[h++],c=new CSG.Vector3D(t,n,r),f=new CSG.Vertex(c),m.push(f);var y,x,w,V,P=e.shared.map((function(e){return CSG.Polygon.Shared.fromObject(e)})),D=[],S=e.numPolygons,_=e.numVerticesPerPolygon,b=e.polygonVertices,T=e.polygonPlaneIndexes,z=e.polygonSharedIndexes;h=0;for(var M=0;M<S;M++){y=_[M],x=[];for(var A=0;A<y;A++)x.push(m[b[h++]]);s=a[T[M]],w=P[z[M]],V=new CSG.Polygon(x,w,s),D.push(V)}var C=CSG.fromPolygons(D);return C.isCanonicalized=!0,C.isRetesselated=!0,C},CSG.prototype={toPolygons:function(){return this.polygons},union:function(e){var t;t=e instanceof Array?e:[e];for(var n=this,r=0;r<t.length;r++){var o=r==t.length-1;n=n.unionSub(t[r],o,o)}return n},unionSub:function(e,t,n){if(this.mayOverlap(e)){var r=new CSG.Tree(this.polygons),o=new CSG.Tree(e.polygons);r.clipTo(o,!1),o.clipTo(r),o.invert(),o.clipTo(r),o.invert();var i=r.allPolygons().concat(o.allPolygons()),s=CSG.fromPolygons(i);return s.properties=this.properties._merge(e.properties),t&&(s=s.reTesselated()),n&&(s=s.canonicalized()),s}return this.unionForNonIntersecting(e)},unionForNonIntersecting:function(e){var t=this.polygons.concat(e.polygons),n=CSG.fromPolygons(t);return n.properties=this.properties._merge(e.properties),n.isCanonicalized=this.isCanonicalized&&e.isCanonicalized,n.isRetesselated=this.isRetesselated&&e.isRetesselated,n},subtract:function(e){var t;t=e instanceof Array?e:[e];for(var n=this,r=0;r<t.length;r++){var o=r==t.length-1;n=n.subtractSub(t[r],o,o)}return n},subtractSub:function(e,t,n){var r=new CSG.Tree(this.polygons),o=new CSG.Tree(e.polygons);r.invert(),r.clipTo(o),o.clipTo(r,!0),r.addPolygons(o.allPolygons()),r.invert();var i=CSG.fromPolygons(r.allPolygons());return i.properties=this.properties._merge(e.properties),t&&(i=i.reTesselated()),n&&(i=i.canonicalized()),i},intersect:function(e){var t;t=e instanceof Array?e:[e];for(var n=this,r=0;r<t.length;r++){var o=r==t.length-1;n=n.intersectSub(t[r],o,o)}return n},intersectSub:function(e,t,n){var r=new CSG.Tree(this.polygons),o=new CSG.Tree(e.polygons);r.invert(),o.clipTo(r),o.invert(),r.clipTo(o),o.clipTo(r),r.addPolygons(o.allPolygons()),r.invert();var i=CSG.fromPolygons(r.allPolygons());return i.properties=this.properties._merge(e.properties),t&&(i=i.reTesselated()),n&&(i=i.canonicalized()),i},inverse:function(){var e=this.polygons.map((function(e){return e.flipped()}));return CSG.fromPolygons(e)},transform1:function(e){var t=this.polygons.map((function(t){return t.transform(e)})),n=CSG.fromPolygons(t);return n.properties=this.properties._transform(e),n.isRetesselated=this.isRetesselated,n},transform:function(e){var t=e.isMirroring(),n={},r={},o=this.polygons.map((function(o){var i,s=o.plane,a=s.getTag();a in r?i=r[a]:(i=s.transform(e),r[a]=i);var l=o.vertices.map((function(t){var r,o=t.getTag();return o in n?r=n[o]:(r=t.transform(e),n[o]=r),r}));return t&&l.reverse(),new CSG.Polygon(l,o.shared,i)})),i=CSG.fromPolygons(o);return i.properties=this.properties._transform(e),i.isRetesselated=this.isRetesselated,i.isCanonicalized=this.isCanonicalized,i},toStlString:function(){var e="solid csg.js\n";return this.polygons.map((function(t){e+=t.toStlString()})),e+="endsolid csg.js\n"},toX3D:function(){var e={},t=[],n={};this.polygons.map((function(r){var o=0,i=0,s=1;r.shared&&r.shared.color&&(o=r.shared.color[0],i=r.shared.color[1],s=r.shared.color[2]);for(var a,l=[],u=r.vertices.length,h=0;h<u;h++)(a=r.vertices[h]).getTag()in n||(t.push(a.pos._x.toString()+" "+a.pos._y.toString()+" "+a.pos._z.toString()),n[a.getTag()]=t.length-1),l.push(n[a.getTag()]);var p=l.join(" "),c=o.toString()+" "+i.toString()+" "+s.toString();c in e||(e[c]=[]),e[c].push(p)}));var r=document.implementation.createDocumentType("X3D",'ISO//Web3D//DTD X3D 3.1//EN" "http://www.web3d.org/specifications/x3d-3.1.dtd',null),o=document.implementation.createDocument(null,"X3D",r);o.insertBefore(o.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"'),o.doctype);var i=o.getElementsByTagName("X3D")[0];i.setAttribute("profile","Interchange"),i.setAttribute("version","3.1"),i.setAttribute("xsd:noNamespaceSchemaLocation","http://www.web3d.org/specifications/x3d-3.1.xsd"),i.setAttribute("xmlns:xsd","http://www.w3.org/2001/XMLSchema-instance");var s=o.createElement("Scene");i.appendChild(s);var a=!1;for(var l in e){var u=e[l],h=o.createElement("Shape");s.appendChild(h);var p=o.createElement("Appearance");h.appendChild(p);var c=o.createElement("Material");p.appendChild(c),c.setAttribute("diffuseColor",l),c.setAttribute("ambientIntensity","1.0");var f=o.createElement("IndexedFaceSet");h.appendChild(f),f.setAttribute("solid","true"),f.setAttribute("coordIndex",u.join(" -1 ")+" -1");var m=o.createElement("Coordinate");f.appendChild(m),a?m.setAttribute("USE","coords_mesh"):(m.setAttribute("DEF","coords_mesh"),m.setAttribute("point",t.join(" ")),a=!0)}var d=(new XMLSerializer).serializeToString(o);return new Blob([d],{type:"model/x3d+xml"})},toStlBinary:function(){var e=new ArrayBuffer(4),t=new Int32Array(e,0,1),n=new Int8Array(e,0,4);if(t[0]=287454020,68!=n[0])throw new Error("Binary STL output is currently only supported on little-endian (Intel) processors");var r=0;this.polygons.map((function(e){var t=e.vertices.length;r+=t>=3?t-2:0}));for(var o=new Uint8Array(80),i=0;i<80;i++)o[i]=65;var s=new Uint32Array(1);s[0]=r;var a=new ArrayBuffer(50*r),l=new Int8Array(a),u=new ArrayBuffer(50),h=new Int8Array(u),p=new Float32Array(u,0,12),c=new Uint16Array(u,48,1),f=0;return this.polygons.map((function(e){for(var t=e.vertices.length,n=0;n<t-2;n++){var r=e.plane.normal;p[0]=r._x,p[1]=r._y,p[2]=r._z;for(var o=3,i=0;i<3;i++){var s=i+(i>0?n:0),a=e.vertices[s].pos;p[o++]=a._x,p[o++]=a._y,p[o++]=a._z}c[0]=0,l.set(h,f),f+=50}})),new Blob([o.buffer,s.buffer,a],{type:"application/sla"})},toString:function(){var e="CSG solid:\n";return this.polygons.map((function(t){e+=t.toString()})),e},expand:function(e,t){var n=this.expandedShell(e,t,!0);return(n=n.reTesselated()).properties=this.properties,n},contract:function(e,t){var n=this.expandedShell(e,t,!1),r=this.subtract(n);return(r=r.reTesselated()).properties=this.properties,r},expandedShell:function(e,t,n){var r,o=this.reTesselated();r=n?o:new CSG,o.polygons.map((function(t){var n=t.plane.normal.unit().times(2*e),o=t.translate(n.times(-.5)).extrude(n);r=r.unionSub(o,!1,!1)}));var i={};for(var s in o.polygons.map((function(e){for(var t=e.vertices.length,n=e.vertices[t-1],r=n.getTag(),o=0;o<t;o++){var s,a,l=e.vertices[o],u=l.getTag();(s=u<r?u+"-"+r:r+"-"+u)in i?a=i[s]:(a={v1:n,v2:l,planenormals:[]},i[s]=a),a.planenormals.push(e.plane.normal),r=u,n=l}})),i){for(var a=i[s],l=a.v1.pos,u=a.v2.pos,h=u.minus(l).unit(),p=a.planenormals[0].unit(),c=p.cross(h),f=[],m=0;m<t;m++)f.push(m*Math.PI*2/t);m=0;for(var d=a.planenormals.length;m<d;m++){var v=a.planenormals[m],g=c.dot(v),y=p.dot(v);(_=Math.atan2(g,y))<0&&(_+=2*Math.PI),f.push(_),(_=Math.atan2(-g,-y))<0&&(_+=2*Math.PI),f.push(_)}var x,w,V=(f=f.sort(fnNumberSort)).length,P=[],D=[],S=[];for(m=-1;m<V;m++){var _=f[m<0?m+V:m],b=(g=Math.sin(_),y=Math.cos(_),p.times(y*e).plus(c.times(g*e))),T=l.plus(b),z=u.plus(b),M=!1;if(m>=0&&T.distanceTo(x)<1e-5&&(M=!0),!M){if(m>=0){P.push(new CSG.Vertex(T)),D.push(new CSG.Vertex(z));var A=[new CSG.Vertex(w),new CSG.Vertex(z),new CSG.Vertex(T),new CSG.Vertex(x)],C=new CSG.Polygon(A);S.push(C)}x=T,w=z}}D.reverse(),S.push(new CSG.Polygon(P)),S.push(new CSG.Polygon(D));var O=CSG.fromPolygons(S);r=r.unionSub(O,!1,!1)}var F={};for(var E in o.polygons.map((function(e){e.vertices.map((function(t){var n,r=t.getTag();r in F?n=F[r]:(n={pos:t.pos,normals:[]},F[r]=n),n.normals.push(e.plane.normal)}))})),F){var B=F[E],N=B.normals[0].unit(),I=null,k=0;for(m=1;m<B.normals.length;m++){var L=B.normals[m].unit(),R=N.cross(L).length();R>.05&&R>k&&(k=R,I=L)}I||(I=N.randomNonParallelVector());var j=N.cross(I).unit(),G=j.cross(N),q=CSG.sphere({center:B.pos,radius:e,resolution:t,axes:[N,j,G]});r=r.unionSub(q,!1,!1)}return r},canonicalized:function(){if(this.isCanonicalized)return this;var e=(new CSG.fuzzyCSGFactory).getCSG(this);return e.isCanonicalized=!0,e.isRetesselated=this.isRetesselated,e.properties=this.properties,e},reTesselated:function(){if(this.isRetesselated)return this;var e=this.canonicalized(),t={};e.polygons.map((function(e){var n=e.plane.getTag();(n+="/"+e.shared.getTag())in t||(t[n]=[]),t[n].push(e)}));var n=[];for(var r in t){var o=t[r];if(o.length<2)n=n.concat(o);else{var i=[];CSG.reTesselateCoplanarPolygons(o,i),n=n.concat(i)}}var s=CSG.fromPolygons(n);return s.isRetesselated=!0,(s=s.canonicalized()).properties=this.properties,s},getBounds:function(){if(!this.cachedBoundingBox){for(var e=new CSG.Vector3D(0,0,0),t=new CSG.Vector3D(0,0,0),n=this.polygons,r=n.length,o=0;o<r;o++){var i=n[o].boundingBox();0===o?(e=i[0],t=i[1]):(e=e.min(i[0]),t=t.max(i[1]))}this.cachedBoundingBox=[e,t]}return this.cachedBoundingBox},mayOverlap:function(e){if(0===this.polygons.length||0===e.polygons.length)return!1;var t=this.getBounds(),n=e.getBounds();return!(t[1].x<n[0].x)&&(!(t[0].x>n[1].x)&&(!(t[1].y<n[0].y)&&(!(t[0].y>n[1].y)&&(!(t[1].z<n[0].z)&&!(t[0].z>n[1].z)))))},cutByPlane:function(e){if(0===this.polygons.length)return new CSG;var t=e.normal.times(e.w),n=0;this.polygons.map((function(e){e.vertices.map((function(e){var r=e.pos.distanceToSquared(t);r>n&&(n=r)}))})),n=Math.sqrt(n),n*=1.01;var r=[],o=new CSG.OrthoNormalBasis(e);r.push(new CSG.Vertex(o.to3D(new CSG.Vector2D(n,-n)))),r.push(new CSG.Vertex(o.to3D(new CSG.Vector2D(-n,-n)))),r.push(new CSG.Vertex(o.to3D(new CSG.Vector2D(-n,n)))),r.push(new CSG.Vertex(o.to3D(new CSG.Vector2D(n,n))));var i=new CSG.Polygon(r,null,e.flipped()).extrude(e.normal.times(-n)),s=this.intersect(i);return s.properties=this.properties,s},connectTo:function(e,t,n,r){var o=e.getTransformationTo(t,n,r);return this.transform(o)},setShared:function(e){var t=this.polygons.map((function(t){return new CSG.Polygon(t.vertices,e,t.plane)})),n=CSG.fromPolygons(t);return n.properties=this.properties,n.isRetesselated=this.isRetesselated,n.isCanonicalized=this.isCanonicalized,n},setColor:function(e,t,n){var r=new CSG.Polygon.Shared([e,t,n]);return this.setShared(r)},toCompactBinary:function(){var e=this.canonicalized(),t=e.polygons.length,n=0,r=0,o={},i=[],s=0,a={},l=0,u=[],h=[],p={},c=0;e.polygons.map((function(e){e.vertices.map((function(e){++n;var t=e.getTag();t in o||(o[t]=r++,i.push(e))}));var t=e.plane.getTag();t in a||(a[t]=s++,u.push(e.plane));var l=e.shared.getTag();l in p||(p[l]=c++,h.push(e.shared))}));var f=new Uint32Array(t),m=new Uint32Array(t),d=new Uint32Array(n),v=new Uint32Array(t),g=new Float64Array(3*r),y=new Float64Array(4*s),x=0;for(l=0;l<t;++l){var w=e.polygons[l];f[l]=w.vertices.length,w.vertices.map((function(e){var t=e.getTag(),n=o[t];d[x++]=n}));var V=w.plane.getTag(),P=a[V];v[l]=P;var D=w.shared.getTag(),S=p[D];m[l]=S}var _=0;i.map((function(e){var t=e.pos;g[_++]=t._x,g[_++]=t._y,g[_++]=t._z}));var b=0;return u.map((function(e){var t=e.normal;y[b++]=t._x,y[b++]=t._y,y[b++]=t._z,y[b++]=e.w})),{class:"CSG",numPolygons:t,numVerticesPerPolygon:f,polygonPlaneIndexes:v,polygonSharedIndexes:m,polygonVertices:d,vertexData:g,planeData:y,shared:h}},toPointCloud:function(e){var t=this.reTesselated(),n=new CSG,r={};for(var o in t.polygons.map((function(e){e.vertices.map((function(e){r[e.getTag()]=e.pos}))})),r){var i=r[o],s=CSG.cube({center:i,radius:e});n=n.unionSub(s,!1,!1)}return n=n.reTesselated()},getTransformationToFlatLying:function(){if(0===this.polygons.length)return new CSG.Matrix4x4;var e=this.canonicalized(),t={};e.polygons.map((function(e){t[e.plane.getTag()]=e.plane}));var n,r=new CSG.Vector3D(1,0,0),o=new CSG.Vector3D(0,1,0),i=new CSG.Vector3D(0,0,1),s=new CSG.Connector([0,0,0],[0,0,-1],r),a=new CSG.Connector([0,0,0],[0,0,-1],o),l=!0,u=0,h=0;for(var p in t){var c,f=t[p],m=f.normal.times(f.w);if(f.normal.cross(r).length()>f.normal.cross(o).length())c=new CSG.Connector(m,f.normal,r).getTransformationTo(s,!1,0);else c=new CSG.Connector(m,f.normal,o).getTransformationTo(a,!1,0);var d=e.transform(c),v=-f.normal.dot(i),g=d.getBounds(),y=g[1].z-g[0].z,x=l;if(x||(y<u||y==u&&v>h)&&(x=!0),x){var w=[-.5*(g[1].x+g[0].x),-.5*(g[1].y+g[0].y),-g[0].z];u=y,h=v,n=c=c.multiply(CSG.Matrix4x4.translation(w))}l=!1}return n},lieFlat:function(){var e=this.getTransformationToFlatLying();return this.transform(e)},projectToOrthoNormalBasis:function(e){var t=[];return this.polygons.map((function(n){var r=n.projectToOrthoNormalBasis(e);r.sides.length>0&&t.push(r)})),(new CAG).union(t)},sectionCut:function(e){var t=e.plane,n=e.plane.flipped();t=new CSG.Plane(t.normal,t.w+1e-4),n=new CSG.Plane(n.normal,n.w+1e-4);var r=this.cutByPlane(t);return(r=r.cutByPlane(n)).projectToOrthoNormalBasis(e)},fixTJunctions:function(){for(var e=this.canonicalized(),t={},n=0;n<e.polygons.length;n++){var r=(L=e.polygons[n]).vertices.length;if(r>=3)for(var o=L.vertices[0],i=o.getTag(),s=0;s<r;s++){var a=s+1;a==r&&(a=0);var l=L.vertices[a],u=l.getTag(),h=i+"/"+u,p=u+"/"+i;if(p in t){var c=t[p];c.splice(-1,1),0===c.length&&delete t[p]}else{var f={vertex0:o,vertex1:l,polygonindex:n};h in t?t[h].push(f):t[h]=[f]}o=l,i=u}}var m={},d={},v={},g=!0;for(var h in t)g=!1,v[h]=!0,t[h].map((function(e){var t=e.vertex0.getTag(),n=e.vertex1.getTag();t in m?m[t].push(h):m[t]=[h],n in d?d[n].push(h):d[n]=[h]}));if(!g){var y=e.polygons.slice(0);function addSide(e,n,r){var o=e.getTag(),i=n.getTag();if(o==i)throw new Error("Assertion failed");var s=o+"/"+i;if(i+"/"+o in t)return deleteSide(n,e,null),null;var a={vertex0:e,vertex1:n,polygonindex:r};return s in t?t[s].push(a):t[s]=[a],o in m?m[o].push(s):m[o]=[s],i in d?d[i].push(s):d[i]=[s],s}function deleteSide(e,n,r){var o=e.getTag(),i=n.getTag(),s=o+"/"+i;if(!(s in t))throw new Error("Assertion failed");for(var a=-1,l=t[s],u=0;u<l.length;u++){var h=l[u];if(h.vertex0==e&&(h.vertex1==n&&(null===r||h.polygonindex==r))){a=u;break}}if(a<0)throw new Error("Assertion failed");if(l.splice(a,1),0===l.length&&delete t[s],(a=m[o].indexOf(s))<0)throw new Error("Assertion failed");if(m[o].splice(a,1),0===m[o].length&&delete m[o],(a=d[i].indexOf(s))<0)throw new Error("Assertion failed");d[i].splice(a,1),0===d[i].length&&delete d[i]}for(;;){g=!0;for(var h in t)g=!1,v[h]=!0;if(g)break;for(var x=!1;;){var w=null;for(var h in v){w=h;break}if(null===w)break;var V=!0;if(w in t){var P=t[w];if(0===P.length)throw new Error("Assertion failed");f=P[0];for(var D=0;D<2;D++){var S=0===D?f.vertex0:f.vertex1,_=0===D?f.vertex1:f.vertex0,b=S.getTag(),T=_.getTag(),z=[];0===D?b in d&&(z=d[b]):b in m&&(z=m[b]);for(var M=0;M<z.length;M++){var A=z[M],C=t[A][0],O=0===D?C.vertex0:C.vertex1,F=0===D?C.vertex1:C.vertex0,E=O.getTag();if(F.getTag()!=b)throw new Error("Assertion failed");if(E==T){deleteSide(S,_,null),deleteSide(_,S,null),V=!1,D=2,x=!0;break}var B=S.pos,N=_.pos,I=O.pos.minus(B),k=N.minus(B).dot(I)/I.dot(I);if(k>0&&k<1&&B.plus(I.times(k)).distanceToSquared(N)<1e-10){for(var L=y[n=C.polygonindex],R=C.vertex1.getTag(),j=-1,G=0;G<L.vertices.length;G++)if(L.vertices[G].getTag()==R){j=G;break}if(j<0)throw new Error("Assertion failed");var q=L.vertices.slice(0);q.splice(j,0,_);var Y=new CSG.Polygon(q,L.shared);y[n]=Y,deleteSide(C.vertex0,C.vertex1,n);var U=addSide(C.vertex0,_,n),X=addSide(_,C.vertex1,n);null!==U&&(v[U]=!0),null!==X&&(v[X]=!0),V=!1,D=2,x=!0;break}}}}V&&delete v[h]}if(!x)break}var W=CSG.fromPolygons(y);W.properties=e.properties,W.isCanonicalized=!0,W.isRetesselated=!0,e=W}g=!0;for(var h in t){g=!1;break}if(!g)throw new Error("!sidemapisempty");return e}},CSG.parseOption=function(e,t,n){var r=n;return e&&t in e&&(r=e[t]),r},CSG.parseOptionAs3DVector=function(e,t,n){var r=CSG.parseOption(e,t,n);return r=new CSG.Vector3D(r)},CSG.parseOptionAs2DVector=function(e,t,n){var r=CSG.parseOption(e,t,n);return r=new CSG.Vector2D(r)},CSG.parseOptionAsFloat=function(e,t,n){var r=CSG.parseOption(e,t,n);if("string"==typeof r)r=Number(r);else if("number"!=typeof r)throw new Error("Parameter "+t+" should be a number");return r},CSG.parseOptionAsInt=function(e,t,n){var r=CSG.parseOption(e,t,n);return Number(Math.floor(r))},CSG.parseOptionAsBool=function(e,t,n){var r=CSG.parseOption(e,t,n);return"string"==typeof r&&("true"==r&&(r=!0),"false"==r&&(r=!1),0===r&&(r=!1)),r=!!r},CSG.cube=function(e){var t=CSG.parseOptionAs3DVector(e,"center",[0,0,0]),n=CSG.parseOptionAs3DVector(e,"radius",[1,1,1]),r=CSG.fromPolygons([[[0,4,6,2],[-1,0,0]],[[1,3,7,5],[1,0,0]],[[0,1,5,4],[0,-1,0]],[[2,6,7,3],[0,1,0]],[[0,2,3,1],[0,0,-1]],[[4,5,7,6],[0,0,1]]].map((function(e){var r=e[0].map((function(e){var r=new CSG.Vector3D(t.x+n.x*(2*!!(1&e)-1),t.y+n.y*(2*!!(2&e)-1),t.z+n.z*(2*!!(4&e)-1));return new CSG.Vertex(r)}));return new CSG.Polygon(r,null)})));return r.properties.cube=new CSG.Properties,r.properties.cube.center=new CSG.Vector3D(t),r.properties.cube.facecenters=[new CSG.Connector(new CSG.Vector3D([n.x,0,0]).plus(t),[1,0,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([-n.x,0,0]).plus(t),[-1,0,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([0,n.y,0]).plus(t),[0,1,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([0,-n.y,0]).plus(t),[0,-1,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([0,0,n.z]).plus(t),[0,0,1],[1,0,0]),new CSG.Connector(new CSG.Vector3D([0,0,-n.z]).plus(t),[0,0,-1],[1,0,0])],r},CSG.sphere=function(e){e=e||{};var t,n,r,o=CSG.parseOptionAs3DVector(e,"center",[0,0,0]),i=CSG.parseOptionAsFloat(e,"radius",1),s=CSG.parseOptionAsInt(e,"resolution",CSG.defaultResolution3D);"axes"in e?(t=e.axes[0].unit().times(i),n=e.axes[1].unit().times(i),r=e.axes[2].unit().times(i)):(t=new CSG.Vector3D([1,0,0]).times(i),n=new CSG.Vector3D([0,-1,0]).times(i),r=new CSG.Vector3D([0,0,1]).times(i)),s<4&&(s=4);for(var a,l=Math.round(s/4),u=[],h=0;h<=s;h++){var p=2*Math.PI*h/s,c=t.times(Math.cos(p)).plus(n.times(Math.sin(p)));if(h>0)for(var f,m,d=[],v=0;v<=l;v++){var g=.5*Math.PI*v/l,y=Math.cos(g),x=Math.sin(g);v>0&&((d=[]).push(new CSG.Vertex(o.plus(a.times(f).minus(r.times(m))))),d.push(new CSG.Vertex(o.plus(c.times(f).minus(r.times(m))))),v<l&&d.push(new CSG.Vertex(o.plus(c.times(y).minus(r.times(x))))),d.push(new CSG.Vertex(o.plus(a.times(y).minus(r.times(x))))),u.push(new CSG.Polygon(d)),(d=[]).push(new CSG.Vertex(o.plus(a.times(f).plus(r.times(m))))),d.push(new CSG.Vertex(o.plus(c.times(f).plus(r.times(m))))),v<l&&d.push(new CSG.Vertex(o.plus(c.times(y).plus(r.times(x))))),d.push(new CSG.Vertex(o.plus(a.times(y).plus(r.times(x))))),d.reverse(),u.push(new CSG.Polygon(d))),f=y,m=x}a=c}var w=CSG.fromPolygons(u);return w.properties.sphere=new CSG.Properties,w.properties.sphere.center=new CSG.Vector3D(o),w.properties.sphere.facepoint=o.plus(t),w},CSG.cylinder=function(e){var t=CSG.parseOptionAs3DVector(e,"start",[0,-1,0]),n=CSG.parseOptionAs3DVector(e,"end",[0,1,0]),r=CSG.parseOptionAsFloat(e,"radius",1),o=CSG.parseOptionAsFloat(e,"radiusEnd",r),i=CSG.parseOptionAsFloat(e,"radiusStart",r);if(o<0||i<0)throw new Error("Radius should be non-negative");if(0===o&&0===i)throw new Error("Either radiusStart or radiusEnd should be positive");var s=CSG.parseOptionAsFloat(e,"resolution",CSG.defaultResolution2D),a=n.minus(t),l=a.unit(),u=l.randomNonParallelVector().unit(),h=u.cross(l).unit(),p=new CSG.Vertex(t),c=new CSG.Vertex(n),f=[];function point(e,n,r){var o=n*Math.PI*2,i=u.times(Math.cos(o)).plus(h.times(Math.sin(o))),s=t.plus(a.times(e)).plus(i.times(r));return new CSG.Vertex(s)}for(var m=0;m<s;m++){var d=m/s,v=(m+1)/s;o==i?(f.push(new CSG.Polygon([p,point(0,d,o),point(0,v,o)])),f.push(new CSG.Polygon([point(0,v,o),point(0,d,o),point(1,d,o),point(1,v,o)])),f.push(new CSG.Polygon([c,point(1,v,o),point(1,d,o)]))):(i>0&&(f.push(new CSG.Polygon([p,point(0,d,i),point(0,v,i)])),f.push(new CSG.Polygon([point(0,d,i),point(1,d,o),point(0,v,i)]))),o>0&&(f.push(new CSG.Polygon([c,point(1,v,o),point(1,d,o)])),f.push(new CSG.Polygon([point(1,d,o),point(1,v,o),point(0,v,i)]))))}var g=CSG.fromPolygons(f);return g.properties.cylinder=new CSG.Properties,g.properties.cylinder.start=new CSG.Connector(t,l.negated(),u),g.properties.cylinder.end=new CSG.Connector(n,l,u),g.properties.cylinder.facepoint=t.plus(u.times(i)),g},CSG.roundedCylinder=function(e){var t,n=CSG.parseOptionAs3DVector(e,"start",[0,-1,0]),r=CSG.parseOptionAs3DVector(e,"end",[0,1,0]),o=CSG.parseOptionAsFloat(e,"radius",1),i=r.minus(n);t=Math.abs(i.x)>Math.abs(i.y)?new CSG.Vector3D(0,1,0):new CSG.Vector3D(1,0,0);var s=CSG.parseOptionAs3DVector(e,"normal",t),a=CSG.parseOptionAsFloat(e,"resolution",CSG.defaultResolution3D);a<4&&(a=4);var l=[],u=Math.floor(.25*a);if(i.length()<1e-10)return CSG.sphere({center:n,radius:o,resolution:a});for(var h,p=i.unit().times(o),c=p.cross(s).unit().times(o),f=c.cross(p).unit().times(o),m=0;m<=a;m++){var d=2*Math.PI*m/a,v=c.times(Math.cos(d)).plus(f.times(Math.sin(d)));if(m>0){var g,y,x=[];x.push(new CSG.Vertex(n.plus(v))),x.push(new CSG.Vertex(n.plus(h))),x.push(new CSG.Vertex(r.plus(h))),x.push(new CSG.Vertex(r.plus(v))),l.push(new CSG.Polygon(x));for(var w=0;w<=u;w++){var V=.5*Math.PI*w/u,P=Math.cos(V),D=Math.sin(V);w>0&&((x=[]).push(new CSG.Vertex(n.plus(h.times(g).minus(p.times(y))))),x.push(new CSG.Vertex(n.plus(v.times(g).minus(p.times(y))))),w<u&&x.push(new CSG.Vertex(n.plus(v.times(P).minus(p.times(D))))),x.push(new CSG.Vertex(n.plus(h.times(P).minus(p.times(D))))),l.push(new CSG.Polygon(x)),(x=[]).push(new CSG.Vertex(r.plus(h.times(g).plus(p.times(y))))),x.push(new CSG.Vertex(r.plus(v.times(g).plus(p.times(y))))),w<u&&x.push(new CSG.Vertex(r.plus(v.times(P).plus(p.times(D))))),x.push(new CSG.Vertex(r.plus(h.times(P).plus(p.times(D))))),x.reverse(),l.push(new CSG.Polygon(x))),g=P,y=D}}h=v}var S=CSG.fromPolygons(l),_=p.unit(),b=c.unit();return S.properties.roundedCylinder=new CSG.Properties,S.properties.roundedCylinder.start=new CSG.Connector(n,_.negated(),b),S.properties.roundedCylinder.end=new CSG.Connector(r,_,b),S.properties.roundedCylinder.facepoint=n.plus(c),S},CSG.roundedCube=function(e){var t=CSG.parseOptionAs3DVector(e,"center",[0,0,0]),n=CSG.parseOptionAs3DVector(e,"radius",[1,1,1]),r=CSG.parseOptionAsFloat(e,"resolution",CSG.defaultResolution3D);r<4&&(r=4);var o=CSG.parseOptionAsFloat(e,"roundradius",.2),i=n;i=i.minus(new CSG.Vector3D(o));var s=CSG.cube({center:t,radius:[n.x,i.y,i.z]});s=(s=s.unionSub(CSG.cube({center:t,radius:[i.x,n.y,i.z]}),!1,!1)).unionSub(CSG.cube({center:t,radius:[i.x,i.y,n.z]}),!1,!1);for(var a=0;a<2;a++){var l=i.z;1==a&&(l=-l);var u=new CSG.Vector3D(i.x,i.y,l).plus(t),h=new CSG.Vector3D(i.x,-i.y,l).plus(t),p=new CSG.Vector3D(-i.x,-i.y,l).plus(t),c=new CSG.Vector3D(-i.x,i.y,l).plus(t),f=CSG.sphere({center:u,radius:o,resolution:r});s=s.unionSub(f,!1,!1),f=CSG.sphere({center:h,radius:o,resolution:r}),s=s.unionSub(f,!1,!1),f=CSG.sphere({center:p,radius:o,resolution:r}),s=s.unionSub(f,!1,!1),f=CSG.sphere({center:c,radius:o,resolution:r}),s=s.unionSub(f,!1,!0);var m=CSG.cylinder({start:u,end:h,radius:o,resolution:r});if(s=s.unionSub(m,!1,!1),m=CSG.cylinder({start:h,end:p,radius:o,resolution:r}),s=s.unionSub(m,!1,!1),m=CSG.cylinder({start:p,end:c,radius:o,resolution:r}),s=s.unionSub(m,!1,!1),m=CSG.cylinder({start:c,end:u,radius:o,resolution:r}),s=s.unionSub(m,!1,!1),0===a){var d=new CSG.Vector3D(0,0,-2*l);m=CSG.cylinder({start:u,end:u.plus(d),radius:o,resolution:r}),s=s.unionSub(m),m=CSG.cylinder({start:h,end:h.plus(d),radius:o,resolution:r}),s=s.unionSub(m),m=CSG.cylinder({start:p,end:p.plus(d),radius:o,resolution:r}),s=s.unionSub(m),m=CSG.cylinder({start:c,end:c.plus(d),radius:o,resolution:r}),s=s.unionSub(m,!1,!0)}}return(s=s.reTesselated()).properties.roundedCube=new CSG.Properties,s.properties.roundedCube.center=new CSG.Vertex(t),s.properties.roundedCube.facecenters=[new CSG.Connector(new CSG.Vector3D([n.x,0,0]).plus(t),[1,0,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([-n.x,0,0]).plus(t),[-1,0,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([0,n.y,0]).plus(t),[0,1,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([0,-n.y,0]).plus(t),[0,-1,0],[0,0,1]),new CSG.Connector(new CSG.Vector3D([0,0,n.z]).plus(t),[0,0,1],[1,0,0]),new CSG.Connector(new CSG.Vector3D([0,0,-n.z]).plus(t),[0,0,-1],[1,0,0])],s},CSG.IsFloat=function(e){return!isNaN(e)||e===1/0||e===-1/0},CSG.solve2Linear=function(e,t,n,r,o,i){var s=1/(e*r-t*n),a=o*r-t*i,l=-o*n+e*i;return[a*=s,l*=s]},CSG.Vector3D=function(e,t,n){if(3==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t),this._z=parseFloat(n);else if(2==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t),this._z=0;else{var r=!0;if(1==arguments.length)if("object"==typeof e)e instanceof CSG.Vector3D?(this._x=e._x,this._y=e._y,this._z=e._z):e instanceof CSG.Vector2D?(this._x=e._x,this._y=e._y,this._z=0):e instanceof Array?e.length<2||e.length>3?r=!1:(this._x=parseFloat(e[0]),this._y=parseFloat(e[1]),3==e.length?this._z=parseFloat(e[2]):this._z=0):"x"in e&&"y"in e?(this._x=parseFloat(e.x),this._y=parseFloat(e.y),this._z="z"in e?parseFloat(e.z):0):r=!1;else{var o=parseFloat(e);this._x=o,this._y=o,this._z=o}else r=!1;if(r&&(CSG.IsFloat(this._x)&&CSG.IsFloat(this._y)&&CSG.IsFloat(this._z)||(r=!1)),!r)throw new Error("wrong arguments")}},CSG.Vector3D.prototype={get x(){return this._x},get y(){return this._y},get z(){return this._z},set x(e){throw new Error("Vector3D is immutable")},set y(e){throw new Error("Vector3D is immutable")},set z(e){throw new Error("Vector3D is immutable")},clone:function(){return new CSG.Vector3D(this)},negated:function(){return new CSG.Vector3D(-this._x,-this._y,-this._z)},abs:function(){return new CSG.Vector3D(Math.abs(this._x),Math.abs(this._y),Math.abs(this._z))},plus:function(e){return new CSG.Vector3D(this._x+e._x,this._y+e._y,this._z+e._z)},minus:function(e){return new CSG.Vector3D(this._x-e._x,this._y-e._y,this._z-e._z)},times:function(e){return new CSG.Vector3D(this._x*e,this._y*e,this._z*e)},dividedBy:function(e){return new CSG.Vector3D(this._x/e,this._y/e,this._z/e)},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z},lerp:function(e,t){return this.plus(e.minus(this).times(t))},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},unit:function(){return this.dividedBy(this.length())},cross:function(e){return new CSG.Vector3D(this._y*e._z-this._z*e._y,this._z*e._x-this._x*e._z,this._x*e._y-this._y*e._x)},distanceTo:function(e){return this.minus(e).length()},distanceToSquared:function(e){return this.minus(e).lengthSquared()},equals:function(e){return this._x==e._x&&this._y==e._y&&this._z==e._z},multiply4x4:function(e){return e.leftMultiply1x3Vector(this)},transform:function(e){return e.leftMultiply1x3Vector(this)},toStlString:function(){return this._x+" "+this._y+" "+this._z},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+", "+this._z.toFixed(2)+")"},randomNonParallelVector:function(){var e=this.abs();return e._x<=e._y&&e._x<=e._z?new CSG.Vector3D(1,0,0):e._y<=e._x&&e._y<=e._z?new CSG.Vector3D(0,1,0):new CSG.Vector3D(0,0,1)},min:function(e){return new CSG.Vector3D(Math.min(this._x,e._x),Math.min(this._y,e._y),Math.min(this._z,e._z))},max:function(e){return new CSG.Vector3D(Math.max(this._x,e._x),Math.max(this._y,e._y),Math.max(this._z,e._z))}},CSG.Vertex=function(e){this.pos=e},CSG.Vertex.fromObject=function(e){var t=new CSG.Vector3D(e.pos);return new CSG.Vertex(t)},CSG.Vertex.prototype={flipped:function(){return this},getTag:function(){var e=this.tag;return e||(e=CSG.getTag(),this.tag=e),e},interpolate:function(e,t){var n=this.pos.lerp(e.pos,t);return new CSG.Vertex(n)},transform:function(e){var t=this.pos.multiply4x4(e);return new CSG.Vertex(t)},toStlString:function(){return"vertex "+this.pos.toStlString()+"\n"},toString:function(){return this.pos.toString()}},CSG.Plane=function(e,t){this.normal=e,this.w=t},CSG.Plane.fromObject=function(e){var t=new CSG.Vector3D(e.normal),n=parseFloat(e.w);return new CSG.Plane(t,n)},CSG.Plane.EPSILON=1e-5,CSG.Plane.fromVector3Ds=function(e,t,n){var r=t.minus(e).cross(n.minus(e)).unit();return new CSG.Plane(r,r.dot(e))},CSG.Plane.anyPlaneFromVector3Ds=function(e,t,n){var r=t.minus(e),o=n.minus(e);r.length()<1e-5&&(r=o.randomNonParallelVector()),o.length()<1e-5&&(o=r.randomNonParallelVector());var i=r.cross(o);return i.length()<1e-5&&(o=r.randomNonParallelVector(),i=r.cross(o)),i=i.unit(),new CSG.Plane(i,i.dot(e))},CSG.Plane.fromPoints=function(e,t,n){return e=new CSG.Vector3D(e),t=new CSG.Vector3D(t),n=new CSG.Vector3D(n),CSG.Plane.fromVector3Ds(e,t,n)},CSG.Plane.fromNormalAndPoint=function(e,t){e=new CSG.Vector3D(e),t=new CSG.Vector3D(t),e=e.unit();var n=t.dot(e);return new CSG.Plane(e,n)},CSG.Plane.prototype={flipped:function(){return new CSG.Plane(this.normal.negated(),-this.w)},getTag:function(){var e=this.tag;return e||(e=CSG.getTag(),this.tag=e),e},equals:function(e){return this.normal.equals(e.normal)&&this.w==e.w},transform:function(e){var t=e.isMirroring(),n=this.normal.randomNonParallelVector(),r=this.normal.cross(n),o=this.normal.cross(r),i=this.normal.times(this.w),s=i.plus(r),a=i.plus(o);i=i.multiply4x4(e),s=s.multiply4x4(e),a=a.multiply4x4(e);var l=CSG.Plane.fromVector3Ds(i,s,a);return t&&(l=l.flipped()),l},splitPolygon:function(e){var t={type:null,front:null,back:null},n=this.normal,r=e.vertices,o=r.length;if(e.plane.equals(this))t.type=0;else{for(var i=CSG.Plane.EPSILON,s=this.w,a=!1,l=!1,u=[],h=-i,p=0;p<o;p++){var c=(_=n.dot(r[p].pos)-s)<0;u.push(c),_>i&&(a=!0),_<h&&(l=!0)}if(a||l)if(l)if(a){t.type=4;for(var f=[],m=[],d=(c=u[0],0);d<o;d++){var v=r[d],g=d+1;g>=o&&(g=0);var y=u[g];if(c==y)c?m.push(v):f.push(v);else{var x=v.pos,w=r[g].pos,V=this.splitLineBetweenPoints(x,w),P=new CSG.Vertex(V);c?(m.push(v),m.push(P),f.push(P)):(f.push(v),f.push(P),m.push(P))}c=y}var D=CSG.Plane.EPSILON*CSG.Plane.EPSILON;if(m.length>=3){var S=m[m.length-1];for(d=0;d<m.length;d++){(v=m[d]).pos.distanceToSquared(S.pos)<D&&(m.splice(d,1),d--),S=v}}if(f.length>=3)for(S=f[f.length-1],d=0;d<f.length;d++){(v=f[d]).pos.distanceToSquared(S.pos)<D&&(f.splice(d,1),d--),S=v}f.length>=3&&(t.front=new CSG.Polygon(f,e.shared,e.plane)),m.length>=3&&(t.back=new CSG.Polygon(m,e.shared,e.plane))}else t.type=3;else t.type=2;else{var _=n.dot(e.plane.normal);t.type=_>=0?0:1}}return t},splitLineBetweenPoints:function(e,t){var n=t.minus(e),r=(this.w-this.normal.dot(e))/this.normal.dot(n);return isNaN(r)&&(r=0),r>1&&(r=1),r<0&&(r=0),e.plus(n.times(r))},intersectWithLine:function(e){return e.intersectWithPlane(this)},intersectWithPlane:function(e){return CSG.Line3D.fromPlanes(this,e)},signedDistanceToPoint:function(e){return this.normal.dot(e)-this.w},toString:function(){return"[normal: "+this.normal.toString()+", w: "+this.w+"]"},mirrorPoint:function(e){var t=this.signedDistanceToPoint(e);return e.minus(this.normal.times(2*t))}},CSG.Polygon=function(e,t,n){this.vertices=e,t||(t=CSG.Polygon.defaultShared),this.shared=t,this.plane=arguments.length>=3?n:CSG.Plane.fromVector3Ds(e[0].pos,e[1].pos,e[2].pos)},CSG.Polygon.fromObject=function(e){var t=e.vertices.map((function(e){return CSG.Vertex.fromObject(e)})),n=CSG.Polygon.Shared.fromObject(e.shared),r=CSG.Plane.fromObject(e.plane);return new CSG.Polygon(t,n,r)},CSG.Polygon.prototype={checkIfConvex:function(){if(!CSG.Polygon.verticesConvex(this.vertices,this.plane.normal))throw CSG.Polygon.verticesConvex(this.vertices,this.plane.normal),new Error("Not convex!")},extrude:function(e){var t=[],n=this;n.plane.normal.dot(e)>0&&(n=n.flipped()),t.push(n);for(var r=n.translate(e),o=this.vertices.length,i=0;i<o;i++){var s=[],a=i<o-1?i+1:0;s.push(n.vertices[i].pos),s.push(r.vertices[i].pos),s.push(r.vertices[a].pos),s.push(n.vertices[a].pos);var l=CSG.Polygon.createFromPoints(s,this.shared);t.push(l)}return r=r.flipped(),t.push(r),CSG.fromPolygons(t)},translate:function(e){return this.transform(CSG.Matrix4x4.translation(e))},boundingSphere:function(){if(!this.cachedBoundingSphere){var e=this.boundingBox(),t=e[0].plus(e[1]).times(.5),n=e[1].minus(t).length();this.cachedBoundingSphere=[t,n]}return this.cachedBoundingSphere},boundingBox:function(){if(!this.cachedBoundingBox){var e,t,n=this.vertices,r=n.length;t=e=0===r?new CSG.Vector3D(0,0,0):n[0].pos;for(var o=1;o<r;o++){var i=n[o].pos;e=e.min(i),t=t.max(i)}this.cachedBoundingBox=[e,t]}return this.cachedBoundingBox},flipped:function(){var e=this.vertices.map((function(e){return e.flipped()}));e.reverse();var t=this.plane.flipped();return new CSG.Polygon(e,this.shared,t)},transform:function(e){var t=this.vertices.map((function(t){return t.transform(e)})),n=this.plane.transform(e);return e.elements[0]*e.elements[5]*e.elements[10]<0&&t.reverse(),new CSG.Polygon(t,this.shared,n)},toStlString:function(){var e="";if(this.vertices.length>=3)for(var t=this.vertices[0].toStlString(),n=0;n<this.vertices.length-2;n++)e+="facet normal "+this.plane.normal.toStlString()+"\nouter loop\n",e+=t,e+=this.vertices[n+1].toStlString(),e+=this.vertices[n+2].toStlString(),e+="endloop\nendfacet\n";return e},toString:function(){var e="Polygon plane: "+this.plane.toString()+"\n";return this.vertices.map((function(t){e+="  "+t.toString()+"\n"})),e},projectToOrthoNormalBasis:function(e){var t=this.vertices.map((function(t){return e.to2D(t.pos)})),n=CAG.fromPointsNoCheck(t),r=n.area();return Math.abs(r)<1e-5?n=new CAG:r<0&&(n=n.flipped()),n}},CSG.Polygon.verticesConvex=function(e,t){var n=e.length;if(n>2)for(var r=e[n-2].pos,o=e[n-1].pos,i=0;i<n;i++){var s=e[i].pos;if(!CSG.Polygon.isConvexPoint(r,o,s,t))return!1;r=o,o=s}return!0},CSG.Polygon.createFromPoints=function(e,t,n){arguments.length<3?new CSG.Vector3D(0,0,0):n.normal;var r=[];return e.map((function(e){var t=new CSG.Vector3D(e),n=new CSG.Vertex(t);r.push(n)})),arguments.length<3?new CSG.Polygon(r,t):new CSG.Polygon(r,t,n)},CSG.Polygon.isConvexPoint=function(e,t,n,r){return t.minus(e).cross(n.minus(t)).dot(r)>=0},CSG.Polygon.isStrictlyConvexPoint=function(e,t,n,r){return t.minus(e).cross(n.minus(t)).dot(r)>=1e-5},CSG.Polygon.Shared=function(e){this.color=e},CSG.Polygon.Shared.fromObject=function(e){return new CSG.Polygon.Shared(e.color)},CSG.Polygon.Shared.prototype={getTag:function(){var e=this.tag;return e||(e=CSG.getTag(),this.tag=e),e},getHash:function(){return this.color?this.color[0]+"/"+this.color[1]+"/"+this.color[2]:"null"}},CSG.Polygon.defaultShared=new CSG.Polygon.Shared(null),CSG.PolygonTreeNode=function(){this.parent=null,this.children=[],this.polygon=null,this.removed=!1},CSG.PolygonTreeNode.prototype={addPolygons:function(e){if(!this.isRootNode())throw new Error("Assertion failed");var t=this;e.map((function(e){t.addChild(e)}))},remove:function(){if(!this.removed){this.removed=!0;var e=this.parent.children,t=e.indexOf(this);if(t<0)throw new Error("Assertion failed");e.splice(t,1),this.parent.recursivelyInvalidatePolygon()}},isRemoved:function(){return this.removed},isRootNode:function(){return!this.parent},invert:function(){if(!this.isRootNode())throw new Error("Assertion failed");this.invertSub()},getPolygon:function(){if(!this.polygon)throw new Error("Assertion failed");return this.polygon},getPolygons:function(e){if(this.polygon)e.push(this.polygon);else{var t=[];this.children.map((function(e){e.getPolygons(t)})),t.map((function(t){e.push(t)}))}},splitByPlane:function(e,t,n,r,o){var i=this.children,s=i.length;if(s>0)for(var a=0;a<s;a++)i[a].splitByPlane(e,t,n,r,o);else{var l=this.polygon;if(l){var u=l.boundingSphere(),h=u[1]+1e-4,p=e.normal,c=u[0],f=p.dot(c)-e.w;if(f>h)r.push(this);else if(f<-h)o.push(this);else{var m=e.splitPolygon(l);switch(m.type){case 0:t.push(this);break;case 1:n.push(this);break;case 2:r.push(this);break;case 3:o.push(this);break;case 4:if(m.front){var d=this.addChild(m.front);r.push(d)}if(m.back){var v=this.addChild(m.back);o.push(v)}}}}}},addChild:function(e){var t=new CSG.PolygonTreeNode;return t.parent=this,t.polygon=e,this.children.push(t),t},invertSub:function(){this.polygon&&(this.polygon=this.polygon.flipped()),this.children.map((function(e){e.invertSub()}))},recursivelyInvalidatePolygon:function(){this.polygon&&(this.polygon=null,this.parent&&this.parent.recursivelyInvalidatePolygon())}},CSG.Tree=function(e){this.polygonTree=new CSG.PolygonTreeNode,this.rootnode=new CSG.Node(null),e&&this.addPolygons(e)},CSG.Tree.prototype={invert:function(){this.polygonTree.invert(),this.rootnode.invert()},clipTo:function(e,t){t=!!t,this.rootnode.clipTo(e,t)},allPolygons:function(){var e=[];return this.polygonTree.getPolygons(e),e},addPolygons:function(e){var t=this,n=e.map((function(e){return t.polygonTree.addChild(e)}));this.rootnode.addPolygonTreeNodes(n)}},CSG.Node=function(e){this.plane=null,this.front=null,this.back=null,this.polygontreenodes=[],this.parent=e},CSG.Node.prototype={invert:function(){this.plane&&(this.plane=this.plane.flipped()),this.front&&this.front.invert(),this.back&&this.back.invert();var e=this.front;this.front=this.back,this.back=e},clipPolygons:function(e,t){if(this.plane){for(var n=[],r=[],o=t?n:r,i=this.plane,s=e.length,a=0;a<s;a++){var l=e[a];l.isRemoved()||l.splitByPlane(i,o,n,r,n)}this.front&&r.length>0&&this.front.clipPolygons(r,t);var u=n.length;if(this.back&&u>0)this.back.clipPolygons(n,t);else for(a=0;a<u;a++)n[a].remove()}},clipTo:function(e,t){this.polygontreenodes.length>0&&e.rootnode.clipPolygons(this.polygontreenodes,t),this.front&&this.front.clipTo(e,t),this.back&&this.back.clipTo(e,t)},addPolygonTreeNodes:function(e){if(0!==e.length){var t=this;if(!this.plane){var n=e[0].getPolygon().plane;this.plane=n}var r=[],o=[];e.map((function(e){e.splitByPlane(t.plane,t.polygontreenodes,o,r,o)})),r.length>0&&(this.front||(this.front=new CSG.Node(this)),this.front.addPolygonTreeNodes(r)),o.length>0&&(this.back||(this.back=new CSG.Node(this)),this.back.addPolygonTreeNodes(o))}},getParentPlaneNormals:function(e,t){t>0&&this.parent&&(e.push(this.parent.plane.normal),this.parent.getParentPlaneNormals(e,t-1))}},CSG.Matrix4x4=function(e){this.elements=arguments.length>=1?e:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},CSG.Matrix4x4.prototype={plus:function(e){for(var t=[],n=0;n<16;n++)t[n]=this.elements[n]+e.elements[n];return new CSG.Matrix4x4(t)},minus:function(e){for(var t=[],n=0;n<16;n++)t[n]=this.elements[n]-e.elements[n];return new CSG.Matrix4x4(t)},multiply:function(e){var t=this.elements[0],n=this.elements[1],r=this.elements[2],o=this.elements[3],i=this.elements[4],s=this.elements[5],a=this.elements[6],l=this.elements[7],u=this.elements[8],h=this.elements[9],p=this.elements[10],c=this.elements[11],f=this.elements[12],m=this.elements[13],d=this.elements[14],v=this.elements[15],g=e.elements[0],y=e.elements[1],x=e.elements[2],w=e.elements[3],V=e.elements[4],P=e.elements[5],D=e.elements[6],S=e.elements[7],_=e.elements[8],b=e.elements[9],T=e.elements[10],z=e.elements[11],M=e.elements[12],A=e.elements[13],C=e.elements[14],O=e.elements[15],F=[];return F[0]=t*g+n*V+r*_+o*M,F[1]=t*y+n*P+r*b+o*A,F[2]=t*x+n*D+r*T+o*C,F[3]=t*w+n*S+r*z+o*O,F[4]=i*g+s*V+a*_+l*M,F[5]=i*y+s*P+a*b+l*A,F[6]=i*x+s*D+a*T+l*C,F[7]=i*w+s*S+a*z+l*O,F[8]=u*g+h*V+p*_+c*M,F[9]=u*y+h*P+p*b+c*A,F[10]=u*x+h*D+p*T+c*C,F[11]=u*w+h*S+p*z+c*O,F[12]=f*g+m*V+d*_+v*M,F[13]=f*y+m*P+d*b+v*A,F[14]=f*x+m*D+d*T+v*C,F[15]=f*w+m*S+d*z+v*O,new CSG.Matrix4x4(F)},clone:function(){var e=this.elements.map((function(e){return e}));return new CSG.Matrix4x4(e)},rightMultiply1x3Vector:function(e){var t=e._x,n=e._y,r=e._z,o=t*this.elements[0]+n*this.elements[1]+r*this.elements[2]+1*this.elements[3],i=t*this.elements[4]+n*this.elements[5]+r*this.elements[6]+1*this.elements[7],s=t*this.elements[8]+n*this.elements[9]+r*this.elements[10]+1*this.elements[11],a=t*this.elements[12]+n*this.elements[13]+r*this.elements[14]+1*this.elements[15];if(1!=a){var l=1/a;o*=l,i*=l,s*=l}return new CSG.Vector3D(o,i,s)},leftMultiply1x3Vector:function(e){var t=e._x,n=e._y,r=e._z,o=t*this.elements[0]+n*this.elements[4]+r*this.elements[8]+1*this.elements[12],i=t*this.elements[1]+n*this.elements[5]+r*this.elements[9]+1*this.elements[13],s=t*this.elements[2]+n*this.elements[6]+r*this.elements[10]+1*this.elements[14],a=t*this.elements[3]+n*this.elements[7]+r*this.elements[11]+1*this.elements[15];if(1!=a){var l=1/a;o*=l,i*=l,s*=l}return new CSG.Vector3D(o,i,s)},rightMultiply1x2Vector:function(e){var t=e.x,n=e.y,r=t*this.elements[0]+n*this.elements[1]+0*this.elements[2]+1*this.elements[3],o=t*this.elements[4]+n*this.elements[5]+0*this.elements[6]+1*this.elements[7],i=(this.elements[8],this.elements[9],this.elements[10],this.elements[11],t*this.elements[12]+n*this.elements[13]+0*this.elements[14]+1*this.elements[15]);if(1!=i){var s=1/i;r*=s,o*=s,s}return new CSG.Vector2D(r,o)},leftMultiply1x2Vector:function(e){var t=e.x,n=e.y,r=t*this.elements[0]+n*this.elements[4]+0*this.elements[8]+1*this.elements[12],o=t*this.elements[1]+n*this.elements[5]+0*this.elements[9]+1*this.elements[13],i=(this.elements[2],this.elements[6],this.elements[10],this.elements[14],t*this.elements[3]+n*this.elements[7]+0*this.elements[11]+1*this.elements[15]);if(1!=i){var s=1/i;r*=s,o*=s,s}return new CSG.Vector2D(r,o)},isMirroring:function(){var e=new CSG.Vector3D(this.elements[0],this.elements[4],this.elements[8]),t=new CSG.Vector3D(this.elements[1],this.elements[5],this.elements[9]),n=new CSG.Vector3D(this.elements[2],this.elements[6],this.elements[10]);return e.cross(t).dot(n)<0}},CSG.Matrix4x4.unity=function(){return new CSG.Matrix4x4},CSG.Matrix4x4.rotationX=function(e){var t=e*Math.PI*(1/180),n=Math.cos(t),r=Math.sin(t),o=[1,0,0,0,0,n,r,0,0,-r,n,0,0,0,0,1];return new CSG.Matrix4x4(o)},CSG.Matrix4x4.rotationY=function(e){var t=e*Math.PI*(1/180),n=Math.cos(t),r=Math.sin(t),o=[n,0,-r,0,0,1,0,0,r,0,n,0,0,0,0,1];return new CSG.Matrix4x4(o)},CSG.Matrix4x4.rotationZ=function(e){var t=e*Math.PI*(1/180),n=Math.cos(t),r=Math.sin(t),o=[n,r,0,0,-r,n,0,0,0,0,1,0,0,0,0,1];return new CSG.Matrix4x4(o)},CSG.Matrix4x4.rotation=function(e,t,n){e=new CSG.Vector3D(e),t=new CSG.Vector3D(t);var r=CSG.Plane.fromNormalAndPoint(t,e),o=new CSG.OrthoNormalBasis(r),i=CSG.Matrix4x4.translation(e.negated());return i=(i=(i=(i=i.multiply(o.getProjectionMatrix())).multiply(CSG.Matrix4x4.rotationZ(n))).multiply(o.getInverseProjectionMatrix())).multiply(CSG.Matrix4x4.translation(e))},CSG.Matrix4x4.translation=function(e){var t=new CSG.Vector3D(e),n=[1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,t.z,1];return new CSG.Matrix4x4(n)},CSG.Matrix4x4.mirroring=function(e){var t=e.normal.x,n=e.normal.y,r=e.normal.z,o=e.w,i=[1-2*t*t,-2*n*t,-2*r*t,0,-2*t*n,1-2*n*n,-2*r*n,0,-2*t*r,-2*n*r,1-2*r*r,0,-2*t*o,-2*n*o,-2*r*o,1];return new CSG.Matrix4x4(i)},CSG.Matrix4x4.scaling=function(e){var t=new CSG.Vector3D(e),n=[t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1];return new CSG.Matrix4x4(n)},CSG.Vector2D=function(e,t){if(2==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t);else{var n=!0;if(1==arguments.length)if("object"==typeof e)e instanceof CSG.Vector2D?(this._x=e._x,this._y=e._y):e instanceof Array?(this._x=parseFloat(e[0]),this._y=parseFloat(e[1])):"x"in e&&"y"in e?(this._x=parseFloat(e.x),this._y=parseFloat(e.y)):n=!1;else{var r=parseFloat(e);this._x=r,this._y=r}else n=!1;if(n&&(CSG.IsFloat(this._x)&&CSG.IsFloat(this._y)||(n=!1)),!n)throw new Error("wrong arguments")}},CSG.Vector2D.fromAngle=function(e){return CSG.Vector2D.fromAngleRadians(e)},CSG.Vector2D.fromAngleDegrees=function(e){var t=Math.PI*e/180;return CSG.Vector2D.fromAngleRadians(t)},CSG.Vector2D.fromAngleRadians=function(e){return new CSG.Vector2D(Math.cos(e),Math.sin(e))},CSG.Vector2D.prototype={get x(){return this._x},get y(){return this._y},set x(e){throw new Error("Vector2D is immutable")},set y(e){throw new Error("Vector2D is immutable")},toVector3D:function(e){return new CSG.Vector3D(this._x,this._y,e)},equals:function(e){return this._x==e._x&&this._y==e._y},clone:function(){return new CSG.Vector2D(this._x,this._y)},negated:function(){return new CSG.Vector2D(-this._x,-this._y)},plus:function(e){return new CSG.Vector2D(this._x+e._x,this._y+e._y)},minus:function(e){return new CSG.Vector2D(this._x-e._x,this._y-e._y)},times:function(e){return new CSG.Vector2D(this._x*e,this._y*e)},dividedBy:function(e){return new CSG.Vector2D(this._x/e,this._y/e)},dot:function(e){return this._x*e._x+this._y*e._y},lerp:function(e,t){return this.plus(e.minus(this).times(t))},length:function(){return Math.sqrt(this.dot(this))},distanceTo:function(e){return this.minus(e).length()},distanceToSquared:function(e){return this.minus(e).lengthSquared()},lengthSquared:function(){return this.dot(this)},unit:function(){return this.dividedBy(this.length())},cross:function(e){return this._x*e._y-this._y*e._x},normal:function(){return new CSG.Vector2D(this._y,-this._x)},multiply4x4:function(e){return e.leftMultiply1x2Vector(this)},transform:function(e){return e.leftMultiply1x2Vector(this)},angle:function(){return this.angleRadians()},angleDegrees:function(){return 180*this.angleRadians()/Math.PI},angleRadians:function(){return Math.atan2(this._y,this._x)},min:function(e){return new CSG.Vector2D(Math.min(this._x,e._x),Math.min(this._y,e._y))},max:function(e){return new CSG.Vector2D(Math.max(this._x,e._x),Math.max(this._y,e._y))},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+")"}},CSG.Line2D=function(e,t){e=new CSG.Vector2D(e),t=parseFloat(t);var n=e.length();t*=n,e=e.times(1/n),this.normal=e,this.w=t},CSG.Line2D.fromPoints=function(e,t){e=new CSG.Vector2D(e);var n=(t=new CSG.Vector2D(t)).minus(e).normal().negated().unit(),r=e.dot(n);return new CSG.Line2D(n,r)},CSG.Line2D.prototype={reverse:function(){return new CSG.Line2D(this.normal.negated(),-this.w)},equals:function(e){return e.normal.equals(this.normal)&&e.w==this.w},origin:function(){return this.normal.times(this.w)},direction:function(){return this.normal.normal()},xAtY:function(e){return(this.w-this.normal._y*e)/this.normal.x},absDistanceToPoint:function(e){var t=(e=new CSG.Vector2D(e)).dot(this.normal);return Math.abs(t-this.w)},intersectWithLine:function(e){var t=CSG.solve2Linear(this.normal.x,this.normal.y,e.normal.x,e.normal.y,this.w,e.w);return t=new CSG.Vector2D(t)},transform:function(e){var t=new CSG.Vector2D(0,0),n=this.normal.times(this.w),r=t.multiply4x4(e),o=this.normal.multiply4x4(e).minus(r),i=n.multiply4x4(e),s=o.dot(i);return new CSG.Line2D(o,s)}},CSG.Line3D=function(e,t){e=new CSG.Vector3D(e),t=new CSG.Vector3D(t),this.point=e,this.direction=t.unit()},CSG.Line3D.fromPoints=function(e,t){e=new CSG.Vector3D(e);var n=(t=new CSG.Vector3D(t)).minus(e).unit();return new CSG.Line3D(e,n)},CSG.Line3D.fromPlanes=function(e,t){var n=e.normal.cross(t.normal),r=n.length();if(r<1e-10)throw new Error("Parallel planes");n=n.times(1/r);var o,i=Math.abs(n.x),s=Math.abs(n.y),a=Math.abs(n.z);if(i>=s&&i>=a){var l=CSG.solve2Linear(e.normal.y,e.normal.z,t.normal.y,t.normal.z,e.w,t.w);o=new CSG.Vector3D(0,l[0],l[1])}else if(s>=i&&s>=a){l=CSG.solve2Linear(e.normal.x,e.normal.z,t.normal.x,t.normal.z,e.w,t.w);o=new CSG.Vector3D(l[0],0,l[1])}else{l=CSG.solve2Linear(e.normal.x,e.normal.y,t.normal.x,t.normal.y,e.w,t.w);o=new CSG.Vector3D(l[0],l[1],0)}return new CSG.Line3D(o,n)},CSG.Line3D.prototype={intersectWithPlane:function(e){var t=(e.w-e.normal.dot(this.point))/e.normal.dot(this.direction);return this.point.plus(this.direction.times(t))},clone:function(e){return new CSG.Line3D(this.point.clone(),this.direction.clone())},reverse:function(){return new CSG.Line3D(this.point.clone(),this.direction.negated())},transform:function(e){var t=this.point.multiply4x4(e),n=this.point.plus(this.direction).multiply4x4(e).minus(t);return new CSG.Line3D(t,n)},closestPointOnLine:function(e){var t=(e=new CSG.Vector3D(e)).minus(this.point).dot(this.direction)/this.direction.dot(this.direction);return this.point.plus(this.direction.times(t))},distanceToPoint:function(e){e=new CSG.Vector3D(e);var t=this.closestPointOnLine(e);return e.minus(t).length()},equals:function(e){return!!this.direction.equals(e.direction)&&!(this.distanceToPoint(e.point)>1e-8)}},CSG.OrthoNormalBasis=function(e,t){t=arguments.length<2?e.normal.randomNonParallelVector():new CSG.Vector3D(t),this.v=e.normal.cross(t).unit(),this.u=this.v.cross(e.normal),this.plane=e,this.planeorigin=e.normal.times(e.w)},CSG.OrthoNormalBasis.Z0Plane=function(){var e=new CSG.Plane(new CSG.Vector3D([0,0,1]),0);return new CSG.OrthoNormalBasis(e,new CSG.Vector3D([1,0,0]))},CSG.OrthoNormalBasis.prototype={getProjectionMatrix:function(){return new CSG.Matrix4x4([this.u.x,this.v.x,this.plane.normal.x,0,this.u.y,this.v.y,this.plane.normal.y,0,this.u.z,this.v.z,this.plane.normal.z,0,0,0,-this.plane.w,1])},getInverseProjectionMatrix:function(){var e=this.plane.normal.times(this.plane.w);return new CSG.Matrix4x4([this.u.x,this.u.y,this.u.z,0,this.v.x,this.v.y,this.v.z,0,this.plane.normal.x,this.plane.normal.y,this.plane.normal.z,0,e.x,e.y,e.z,1])},to2D:function(e){return new CSG.Vector2D(e.dot(this.u),e.dot(this.v))},to3D:function(e){return this.planeorigin.plus(this.u.times(e.x)).plus(this.v.times(e.y))},line3Dto2D:function(e){var t=e.point,n=e.direction.plus(t),r=this.to2D(t),o=this.to2D(n);return CSG.Line2D.fromPoints(r,o)},line2Dto3D:function(e){var t=e.origin(),n=e.direction().plus(t),r=this.to3D(t),o=this.to3D(n);return CSG.Line3D.fromPoints(r,o)},transform:function(e){var t=this.plane.transform(e),n=this.u.transform(e),r=new CSG.Vector3D(0,0,0).transform(e),o=n.minus(r);return new CSG.OrthoNormalBasis(t,o)}},CSG.interpolateBetween2DPointsForY=function(e,t,n){var r,o=n-e.y,i=t.y-e.y;return i<0&&(o=-o,i=-i),r=o<=0?0:o>=i?1:i<1e-10?.5:o/i,e.x+r*(t.x-e.x)},CSG.reTesselateCoplanarPolygons=function(e,t){var n=1e-5,r=e.length;if(r>0){for(var o=e[0].plane,i=e[0].shared,s=new CSG.OrthoNormalBasis(o),a=[],l=[],u={},h={},p={},c=1/n*10,f=0;f<r;f++){var m=e[f],d=[],v=-1;if((E=m.vertices.length)>0){for(var g,y,x=0;x<E;x++){var w,V=s.to2D(m.vertices[x].pos),P=Math.floor(V.y*c);P in p?w=p[P]:P+1 in p?w=p[P+1]:P-1 in p?w=p[P-1]:(w=V.y,p[P]=V.y),V=new CSG.Vector2D(V.x,w),d.push(V);var D=V.y;(0===x||D<g)&&(g=D,v=x),(0===x||D>y)&&(y=D,x),D in h||(h[D]={}),h[D][f]=!0}g>=y?d=[]:(g in u||(u[g]=[]),u[g].push(f))}d.reverse(),v=E-v-1,a.push(d),l.push(v)}var S=[];for(var _ in h)S.push(_);S.sort(fnNumberSort);for(var b=[],T=[],z=0;z<S.length;z++){for(var M,A=[],C=S[z],O=(_=Number(C),h[C]),F=0;F<b.length;++F){if(O[f=(X=b[F]).polygonindex]){for(var E=(d=a[f]).length,B=X.leftvertexindex,N=X.rightvertexindex;;){if((q=B+1)>=E&&(q=0),d[q].y!=_)break;B=q}if((Y=N-1)<0&&(Y=E-1),d[Y].y==_&&(N=Y),B!=X.leftvertexindex&&B==N)b.splice(F,1),--F;else X.leftvertexindex=B,X.rightvertexindex=N,X.topleft=d[B],X.topright=d[N],(q=B+1)>=E&&(q=0),X.bottomleft=d[q],(Y=N-1)<0&&(Y=E-1),X.bottomright=d[Y]}}if(z>=S.length-1)b=[],M=null;else{var I=.5*(_+(M=Number(S[z+1]))),k=u[C];for(var L in k){E=(d=a[f=k[L]]).length;for(var R=l[f],j=R;;){if((x=j+1)>=E&&(x=0),d[x].y!=_)break;if(x==R)break;j=x}for(var G=R;;){if((x=G-1)<0&&(x=E-1),d[x].y!=_)break;if(x==j)break;G=x}var q,Y;(q=j+1)>=E&&(q=0),(Y=G-1)<0&&(Y=E-1),insertSorted(b,{polygonindex:f,leftvertexindex:j,rightvertexindex:G,topleft:d[j],topright:d[G],bottomleft:d[q],bottomright:d[Y]},(function(e,t){var n=CSG.interpolateBetween2DPointsForY(e.topleft,e.bottomleft,I),r=CSG.interpolateBetween2DPointsForY(t.topleft,t.bottomleft,I);return n>r?1:n<r?-1:0}))}}for(var U in b){E=(d=a[f=(X=b[U]).polygonindex]).length;var X,W=CSG.interpolateBetween2DPointsForY(X.topleft,X.bottomleft,_),Z=new CSG.Vector2D(W,_);W=CSG.interpolateBetween2DPointsForY(X.topright,X.bottomright,_);var K=new CSG.Vector2D(W,_);W=CSG.interpolateBetween2DPointsForY(X.topleft,X.bottomleft,M);var J=new CSG.Vector2D(W,M);W=CSG.interpolateBetween2DPointsForY(X.topright,X.bottomright,M);var H=new CSG.Vector2D(W,M),Q={topleft:Z,topright:K,bottomleft:J,bottomright:H,leftline:CSG.Line2D.fromPoints(Z,J),rightline:CSG.Line2D.fromPoints(H,K)};if(A.length>0){var $=A[A.length-1],ee=Q.topleft.distanceTo($.topright),te=Q.bottomleft.distanceTo($.bottomright);ee<n&&te<n&&(Q.topleft=$.topleft,Q.leftline=$.leftline,Q.bottomleft=$.bottomleft,A.splice(A.length-1,1))}A.push(Q)}if(z>0){var ne={},re={};for(x=0;x<A.length;x++)for(var oe=A[x],ie=0;ie<T.length;ie++){if(!re[ie])if((le=T[ie]).bottomleft.distanceTo(oe.topleft)<n&&le.bottomright.distanceTo(oe.topright)<n){re[ie]=!0;ee=oe.leftline.direction().x-le.leftline.direction().x,te=oe.rightline.direction().x-le.rightline.direction().x;var se=Math.abs(ee)<n,ae=Math.abs(te)<n;(se||ee>=0)&&(ae||te>=0)&&(oe.outpolygon=le.outpolygon,oe.leftlinecontinues=se,oe.rightlinecontinues=ae,ne[ie]=!0);break}}for(ie=0;ie<T.length;ie++)if(!ne[ie]){var le;(le=T[ie]).outpolygon.rightpoints.push(le.bottomright),le.bottomright.distanceTo(le.bottomleft)>n&&le.outpolygon.leftpoints.push(le.bottomleft),le.outpolygon.leftpoints.reverse();var ue=le.outpolygon.rightpoints.concat(le.outpolygon.leftpoints),he=[];ue.map((function(e){var t=s.to3D(e),n=new CSG.Vertex(t);he.push(n)}));var pe=new CSG.Polygon(he,i,o);t.push(pe)}}for(x=0;x<A.length;x++){(oe=A[x]).outpolygon?(oe.leftlinecontinues||oe.outpolygon.leftpoints.push(oe.topleft),oe.rightlinecontinues||oe.outpolygon.rightpoints.push(oe.topright)):(oe.outpolygon={leftpoints:[],rightpoints:[]},oe.outpolygon.leftpoints.push(oe.topleft),oe.topleft.distanceTo(oe.topright)>n&&oe.outpolygon.rightpoints.push(oe.topright))}T=A}}},CSG.fuzzyFactory=function(e,t){for(var n=[],r=0;r<e;r++)n.push({});this.lookuptable=n,this.nextElementId=1,this.multiplier=1/t,this.objectTable={}},CSG.fuzzyFactory.prototype={lookupOrCreate:function(e,t){var n,r=this.lookupKey(e);if(null===r){n=t(e),r=this.nextElementId++,this.objectTable[r]=n;for(var o=0;o<e.length;o++){var i=this.lookuptable[o],s=e[o]*this.multiplier,a=Math.floor(s),l=Math.ceil(s);CSG.fuzzyFactory.insertKey(r,i,a),CSG.fuzzyFactory.insertKey(r,i,l)}}else n=this.objectTable[r];return n},lookupKey:function(e){for(var t={},n=0;n<e.length;n++){var r=this.lookuptable[n],o=e[n],i=Math.round(o*this.multiplier);if(!((i+="")in r))return null;if(t=0===n?r[i]:CSG.fuzzyFactory.intersectSets(t,r[i]),CSG.fuzzyFactory.isEmptySet(t))return null}for(var s in t)return s;return null},lookupKeySetForDimension:function(e,t){var n=this.lookuptable[e],r=(this.multiplier,Math.floor(t*this.multiplier));return r in n?n[r]:{}}},CSG.fuzzyFactory.insertKey=function(e,t,n){if(n in t)t[n][e]=!0;else{var r={};r[e]=!0,t[n]=r}},CSG.fuzzyFactory.isEmptySet=function(e){for(var t in e)return!1;return!0},CSG.fuzzyFactory.intersectSets=function(e,t){var n={};for(var r in e)r in t&&(n[r]=!0);return n},CSG.fuzzyFactory.joinSets=function(e,t){var n,r={};for(n in e)r[n]=!0;for(n in t)r[n]=!0;return r},CSG.fuzzyCSGFactory=function(){this.vertexfactory=new CSG.fuzzyFactory(3,1e-5),this.planefactory=new CSG.fuzzyFactory(4,1e-5),this.polygonsharedfactory={}},CSG.fuzzyCSGFactory.prototype={getPolygonShared:function(e){var t=e.getHash();return t in this.polygonsharedfactory?this.polygonsharedfactory[t]:(this.polygonsharedfactory[t]=e,e)},getVertex:function(e){var t=[e.pos._x,e.pos._y,e.pos._z];return this.vertexfactory.lookupOrCreate(t,(function(t){return e}))},getPlane:function(e){var t=[e.normal._x,e.normal._y,e.normal._z,e.w];return this.planefactory.lookupOrCreate(t,(function(t){return e}))},getPolygon:function(e){var t=this.getPlane(e.plane),n=this.getPolygonShared(e.shared),r=this,o=e.vertices.map((function(e){return r.getVertex(e)}));return new CSG.Polygon(o,n,t)},getCSG:function(e){var t=this,n=e.polygons.map((function(e){return t.getPolygon(e)}));return CSG.fromPolygons(n)}},CSG.staticTag=1,CSG.getTag=function(){return CSG.staticTag++},CSG.Properties=function(){},CSG.Properties.prototype={_transform:function(e){var t=new CSG.Properties;return CSG.Properties.transformObj(this,t,e),t},_merge:function(e){var t=new CSG.Properties;return CSG.Properties.cloneObj(this,t),CSG.Properties.addFrom(t,e),t}},CSG.Properties.transformObj=function(e,t,n){for(var r in e)if("_transform"!=r&&"_merge"!=r){var o=e[r],i=o;"object"==typeof o&&("transform"in o&&"function"==typeof o.transform?i=o.transform(n):o instanceof Array?(i=[],CSG.Properties.transformObj(o,i,n)):o instanceof CSG.Properties&&(i=new CSG.Properties,CSG.Properties.transformObj(o,i,n))),t[r]=i}},CSG.Properties.cloneObj=function(e,t){for(var n in e)if("_transform"!=n&&"_merge"!=n){var r=e[n],o=r;if("object"==typeof r)if(r instanceof Array){o=[];for(var i=0;i<r.length;i++)o.push(r[i])}else r instanceof CSG.Properties&&(o=new CSG.Properties,CSG.Properties.cloneObj(r,o));t[n]=o}},CSG.Properties.addFrom=function(e,t){for(var n in t)"_transform"!=n&&"_merge"!=n&&(n in e&&"object"==typeof e[n]&&e[n]instanceof CSG.Properties&&"object"==typeof t[n]&&t[n]instanceof CSG.Properties?CSG.Properties.addFrom(e[n],t[n]):n in e||(e[n]=t[n]))},CSG.Connector=function(e,t,n){this.point=new CSG.Vector3D(e),this.axisvector=new CSG.Vector3D(t).unit(),this.normalvector=new CSG.Vector3D(n).unit()},CSG.Connector.prototype={normalized:function(){var e=this.axisvector.unit(),t=this.normalvector.cross(e).unit(),n=e.cross(t);return new CSG.Connector(this.point,e,n)},transform:function(e){var t=this.point.multiply4x4(e),n=this.point.plus(this.axisvector).multiply4x4(e).minus(t),r=this.point.plus(this.normalvector).multiply4x4(e).minus(t);return new CSG.Connector(t,n,r)},getTransformationTo:function(e,t,n){t=!!t,n=n?Number(n):0;var r=this.normalized();e=e.normalized();var o=CSG.Matrix4x4.translation(this.point.negated()),i=CSG.Plane.anyPlaneFromVector3Ds(new CSG.Vector3D(0,0,0),r.axisvector,e.axisvector),s=new CSG.OrthoNormalBasis(i),a=s.to2D(r.axisvector).angle(),l=s.to2D(e.axisvector).angle(),u=180*(l-a)/Math.PI;t&&(u+=180),o=(o=(o=o.multiply(s.getProjectionMatrix())).multiply(CSG.Matrix4x4.rotationZ(u))).multiply(s.getInverseProjectionMatrix());var h=r.transform(o),p=CSG.Plane.fromNormalAndPoint(e.axisvector,new CSG.Vector3D(0,0,0)),c=new CSG.OrthoNormalBasis(p);a=c.to2D(h.normalvector).angle(),u=180*((l=c.to2D(e.normalvector).angle())-a)/Math.PI,u+=n,o=(o=(o=(o=o.multiply(c.getProjectionMatrix())).multiply(CSG.Matrix4x4.rotationZ(u))).multiply(c.getInverseProjectionMatrix())).multiply(CSG.Matrix4x4.translation(e.point));r.transform(o);return o},axisLine:function(){return new CSG.Line3D(this.point,this.axisvector)},extend:function(e){var t=this.point.plus(this.axisvector.unit().times(e));return new CSG.Connector(t,this.axisvector,this.normalvector)}},CSG.Path2D=function(e,t){e=e||[];var n=null;(t=!!t)&&e.length>0&&(n=new CSG.Vector2D(e[e.length-1]));var r=[];e.map((function(e){e=new CSG.Vector2D(e);var t=!1;null!==n&&(t=e.distanceTo(n)<1e-5);t||r.push(e),n=e})),this.points=r,this.closed=t},CSG.Path2D.arc=function(e){for(var t=CSG.parseOptionAs2DVector(e,"center",0),n=CSG.parseOptionAsFloat(e,"radius",1),r=CSG.parseOptionAsFloat(e,"startangle",0),o=CSG.parseOptionAsFloat(e,"endangle",360),i=CSG.parseOptionAsFloat(e,"resolution",CSG.defaultResolution2D),s=CSG.parseOptionAsBool(e,"maketangent",!1);o-r>=720;)o-=360;for(;o-r<=-720;)o+=360;var a,l=[],u=Math.abs(o-r);if(u<1e-5)a=CSG.Vector2D.fromAngle(r/180*Math.PI).times(n),l.push(a.plus(t));else{var h=Math.floor(i*u/360)+1,p=.5*h/u;p>.25&&(p=.25);for(var c=s?h+2:h,f=0;f<=c;f++){var m=f;s&&((m=(f-1)*(h-2*p)/h+p)<0&&(m=0),m>h&&(m=h));var d=r+m*(o-r)/h;a=CSG.Vector2D.fromAngle(d/180*Math.PI).times(n),l.push(a.plus(t))}}return new CSG.Path2D(l,!1)},CSG.Path2D.prototype={concat:function(e){if(this.closed||e.closed)throw new Error("Paths must not be closed");var t=this.points.concat(e.points);return new CSG.Path2D(t)},appendPoint:function(e){if(this.closed)throw new Error("Paths must not be closed");var t=this.points.concat([e]);return new CSG.Path2D(t)},close:function(){return new CSG.Path2D(this.points,!0)},rectangularExtrude:function(e,t,n){return this.expandToCAG(e/2,n).extrude({offset:[0,0,t]})},expandToCAG:function(e,t){var n,r=[],o=this.points.length,i=0;this.closed&&o>2&&(i=-1);for(var s=i;s<o;s++){var a=s;a<0&&(a=o-1);var l=this.points[a],u=new CAG.Vertex(l);if(s>i){var h=new CAG.Side(n,u);r.push(h)}n=u}return CAG.fromSides(r).expandedShell(e,t)},innerToCAG:function(){if(!this.closed)throw new Error("The path should be closed!");return CAG.fromPoints(this.points)},transform:function(e){var t=this.points.map((function(t){return t.multiply4x4(e)}));return new CSG.Path2D(t,this.closed)}},CSG.addTransformationMethodsToPrototype=function(e){e.mirrored=function(e){return this.transform(CSG.Matrix4x4.mirroring(e))},e.mirroredX=function(){var e=new CSG.Plane(new CSG.Vector3D(1,0,0),0);return this.mirrored(e)},e.mirroredY=function(){var e=new CSG.Plane(new CSG.Vector3D(0,1,0),0);return this.mirrored(e)},e.mirroredZ=function(){var e=new CSG.Plane(new CSG.Vector3D(0,0,1),0);return this.mirrored(e)},e.translate=function(e){return this.transform(CSG.Matrix4x4.translation(e))},e.scale=function(e){return this.transform(CSG.Matrix4x4.scaling(e))},e.rotateX=function(e){return this.transform(CSG.Matrix4x4.rotationX(e))},e.rotateY=function(e){return this.transform(CSG.Matrix4x4.rotationY(e))},e.rotateZ=function(e){return this.transform(CSG.Matrix4x4.rotationZ(e))},e.rotate=function(e,t,n){return this.transform(CSG.Matrix4x4.rotation(e,t,n))}};var CAG=function(){this.sides=[]};function fnSortByIndex(e,t){return e.index-t.index}CAG.fromSides=function(e){var t=new CAG;return t.sides=e,t},CAG.fromPoints=function(e){var t=e.length;if(t<3)throw new Error("CAG shape needs at least 3 points");var n=[],r=new CSG.Vector2D(e[t-1]),o=new CAG.Vertex(r);e.map((function(e){var t=new CSG.Vector2D(e),r=new CAG.Vertex(t),i=new CAG.Side(o,r);n.push(i),o=r}));var i=CAG.fromSides(n);if(i.isSelfIntersecting())throw new Error("Polygon is self intersecting!");var s=i.area();if(Math.abs(s)<1e-5)throw new Error("Degenerate polygon!");return s<0&&(i=i.flipped()),i=i.canonicalized()},CAG.fromPointsNoCheck=function(e){var t=[],n=new CSG.Vector2D(e[e.length-1]),r=new CAG.Vertex(n);return e.map((function(e){var n=new CSG.Vector2D(e),o=new CAG.Vertex(n),i=new CAG.Side(r,o);t.push(i),r=o})),CAG.fromSides(t)},CAG.fromFakeCSG=function(e){var t=e.polygons.map((function(e){return CAG.Side.fromFakePolygon(e)}));return CAG.fromSides(t)},CAG.linesIntersect=function(e,t,n,r){if(t.equals(n)||r.equals(e)){if(r.minus(n).unit().plus(t.minus(e).unit()).length()<1e-5)return!0}else{var o=t.minus(e),i=r.minus(n);if(Math.abs(o.cross(i))<1e-9)return!1;var s=CSG.solve2Linear(-o.x,i.x,-o.y,i.y,e.x-n.x,e.y-n.y);if(s[0]>1e-6&&s[0]<.999999&&s[1]>1e-5&&s[1]<.999999)return!0}return!1},CAG.circle=function(e){e=e||{};for(var t,n=CSG.parseOptionAs2DVector(e,"center",[0,0]),r=CSG.parseOptionAsFloat(e,"radius",1),o=CSG.parseOptionAsInt(e,"resolution",CSG.defaultResolution2D),i=[],s=0;s<=o;s++){var a=2*Math.PI*s/o,l=CSG.Vector2D.fromAngleRadians(a).times(r).plus(n),u=new CAG.Vertex(l);s>0&&i.push(new CAG.Side(t,u)),t=u}return CAG.fromSides(i)},CAG.rectangle=function(e){e=e||{};var t=CSG.parseOptionAs2DVector(e,"center",[0,0]),n=CSG.parseOptionAs2DVector(e,"radius",[1,1]),r=new CSG.Vector2D(n.x,-n.y),o=[t.plus(n),t.plus(r),t.minus(n),t.minus(r)];return CAG.fromPoints(o)},CAG.roundedRectangle=function(e){e=e||{};var t=CSG.parseOptionAs2DVector(e,"center",[0,0]),n=CSG.parseOptionAs2DVector(e,"radius",[1,1]),r=CSG.parseOptionAsFloat(e,"roundradius",.2),o=CSG.parseOptionAsFloat(e,"resolution",CSG.defaultResolution2D),i=Math.min(n.x,n.y);i-=.1,r=Math.min(r,i),r=Math.max(0,r),n=new CSG.Vector2D(n.x-r,n.y-r);var s=CAG.rectangle({center:t,radius:n});return r>0&&(s=s.expand(r,o)),s},CAG.fromCompactBinary=function(e){if("CAG"!=e.class)throw new Error("Not a CAG");for(var t=[],n=e.vertexData,r=n.length/2,o=0,i=0;i<r;i++){var s=n[o++],a=n[o++],l=new CSG.Vector2D(s,a),u=new CAG.Vertex(l);t.push(u)}var h=[],p=e.sideVertexIndices.length/2;o=0;for(var c=0;c<p;c++){var f=e.sideVertexIndices[o++],m=e.sideVertexIndices[o++],d=new CAG.Side(t[f],t[m]);h.push(d)}var v=CAG.fromSides(h);return v.isCanonicalized=!0,v},CAG.prototype={toString:function(){var e="CAG ("+this.sides.length+" sides):\n";return this.sides.map((function(t){e+="  "+t.toString()+"\n"})),e},toCSG:function(e,t){var n=this.sides.map((function(n){return n.toPolygon3D(e,t)}));return CSG.fromPolygons(n)},toDebugString1:function(){this.sides.sort((function(e,t){return e.vertex0.pos.x-t.vertex0.pos.x}));var e="";return this.sides.map((function(t){e+="("+t.vertex0.pos.x+","+t.vertex0.pos.y+") - ("+t.vertex1.pos.x+","+t.vertex1.pos.y+")\n"})),e},toDebugString:function(){var e="CAG.fromSides([\n";return this.sides.map((function(t){e+="  new CAG.Side(new CAG.Vertex(new CSG.Vector2D("+t.vertex0.pos.x+","+t.vertex0.pos.y+")), new CAG.Vertex(new CSG.Vector2D("+t.vertex1.pos.x+","+t.vertex1.pos.y+"))),\n"})),e+="]);\n"},union:function(e){var t;t=e instanceof Array?e:[e];var n=this.toCSG(-1,1);return t.map((function(e){n=n.unionSub(e.toCSG(-1,1),!1,!1)})),n=(n=n.reTesselated()).canonicalized(),(e=CAG.fromFakeCSG(n)).canonicalized()},subtract:function(e){var t;t=e instanceof Array?e:[e];var n=this.toCSG(-1,1);return t.map((function(e){n=n.subtractSub(e.toCSG(-1,1),!1,!1)})),n=(n=n.reTesselated()).canonicalized(),n=(n=CAG.fromFakeCSG(n)).canonicalized()},intersect:function(e){var t;t=e instanceof Array?e:[e];var n=this.toCSG(-1,1);return t.map((function(e){n=n.intersectSub(e.toCSG(-1,1),!1,!1)})),n=(n=n.reTesselated()).canonicalized(),n=(n=CAG.fromFakeCSG(n)).canonicalized()},transform:function(e){var t=e.isMirroring(),n=this.sides.map((function(t){return t.transform(e)})),r=CAG.fromSides(n);return t&&(r=r.flipped()),r},area:function(){var e=0;return this.sides.map((function(t){e+=t.vertex0.pos.cross(t.vertex1.pos)})),e*=.5},flipped:function(){var e=this.sides.map((function(e){return e.flipped()}));return e.reverse(),CAG.fromSides(e)},getBounds:function(){var e,t=e=0===this.sides.length?new CSG.Vector2D(0,0):this.sides[0].vertex0.pos;return this.sides.map((function(n){e=(e=e.min(n.vertex0.pos)).min(n.vertex1.pos),t=(t=t.max(n.vertex0.pos)).max(n.vertex1.pos)})),[e,t]},isSelfIntersecting:function(){for(var e=this.sides.length,t=0;t<e;t++)for(var n=this.sides[t],r=t+1;r<e;r++){var o=this.sides[r];if(CAG.linesIntersect(n.vertex0.pos,n.vertex1.pos,o.vertex0.pos,o.vertex1.pos))return!0}return!1},expandedShell:function(e,t){(t=t||8)<4&&(t=4);var n=[],r={},o=this.canonicalized();for(var i in o.sides.map((function(t){var o=t.vertex1.pos.minus(t.vertex0.pos),i=o.length();if(i>1e-5){var s=(o=o.times(1/i)).normal().times(e),a=[t.vertex1.pos.plus(s),t.vertex1.pos.minus(s),t.vertex0.pos.minus(s),t.vertex0.pos.plus(s)],l=CAG.fromPoints(a);n.push(l);for(var u=0;u<2;u++){var h=0===u?t.vertex0.pos:t.vertex1.pos,p=0===u?t.vertex1.pos:t.vertex0.pos,c=h.x+" "+h.y;c in r||(r[c]=[]),r[c].push({p1:h,p2:p})}}})),r){var s,a,l=r[i],u=l[0].p1;if(2==l.length){var h=l[0].p2,p=l[1].p2;if(s=h.minus(u).angleDegrees(),(a=p.minus(u).angleDegrees())<s&&(a+=360),a>=s+360&&(a-=360),a<s+180){var c=a;a=s+360,s=c}s+=90,a-=90}else s=0,a=360;var f=a>s+359.999;if(f&&(s=0,a=360),a>s+1e-5){var m=[];f||m.push(u);var d=Math.round(t*(a-s)/360);d<1&&(d=1);for(var v=0;v<=d;v++){var g=s+v/d*(a-s);v==d&&(g=a);var y=u.plus(CSG.Vector2D.fromAngleDegrees(g).times(e));(!f||v>0)&&m.push(y)}var x=CAG.fromPointsNoCheck(m);n.push(x)}}var w=new CAG;return w=w.union(n)},expand:function(e,t){return this.union(this.expandedShell(e,t))},contract:function(e,t){return this.subtract(this.expandedShell(e,t))},extrude:function(e){if(0==this.sides.length)return new CSG;var t=CSG.parseOptionAs3DVector(e,"offset",[0,0,1]),n=CSG.parseOptionAsFloat(e,"twistangle",0),r=CSG.parseOptionAsInt(e,"twiststeps",10);0==n&&(r=1),r<1&&(r=1);for(var o,i,s=[],a=0;a<=r;a++){var l=a/r,u=this,h=n*l;0!=h&&(u=u.rotateZ(h));var p=new CSG.Vector2D(t.x,t.y).times(l),c=(u=u.translate(p)).getBounds();c[0]=c[0].minus(new CSG.Vector2D(1,1)),c[1]=c[1].plus(new CSG.Vector2D(1,1));var f=t.z*l;if(0==a||a==r){var m=u.toCSG(f-1,f+1),d=CSG.fromPolygons([new CSG.Polygon([new CSG.Vertex(new CSG.Vector3D(c[0].x,c[0].y,f)),new CSG.Vertex(new CSG.Vector3D(c[1].x,c[0].y,f)),new CSG.Vertex(new CSG.Vector3D(c[1].x,c[1].y,f)),new CSG.Vertex(new CSG.Vector3D(c[0].x,c[1].y,f))])]),v=0==a;t.z<0&&(v=!v),v&&(d=d.inverse()),(d=d.intersect(m)).polygons.map((function(e){Math.abs(e.plane.normal.z)>.99&&s.push(e)}))}if(a>0)for(var g=u.sides.length,y=0;y<g;y++){var x=u.sides[y],w=o.sides[y],V=new CSG.Polygon([new CSG.Vertex(x.vertex1.pos.toVector3D(f)),new CSG.Vertex(x.vertex0.pos.toVector3D(f)),new CSG.Vertex(w.vertex0.pos.toVector3D(i))]),P=new CSG.Polygon([new CSG.Vertex(x.vertex1.pos.toVector3D(f)),new CSG.Vertex(w.vertex0.pos.toVector3D(i)),new CSG.Vertex(w.vertex1.pos.toVector3D(i))]);t.z<0&&(V=V.flipped(),P=P.flipped()),s.push(V),s.push(P)}o=u,i=f}return CSG.fromPolygons(s)},extrudeExperimental:function(e){if(0===this.sides.length)return new CSG;var t=CSG.parseOptionAs3DVector(e,"offset",[0,0,1]),n=CSG.parseOptionAsFloat(e,"twistangle",0),r=CSG.parseOptionAsInt(e,"twiststeps",10),o=CSG.parseOptionAsInt(e,"numslices",10),i=CSG.parseOption(e,"transform",null);r<1&&(r=1),"twiststeps"in e&&"numslices"in e&&(o=Math.max(r,o)),0==n&&null==i&&(o=1);for(var s,a,l,u=[],h=new CSG.Vector2D(t.x,t.y),p=0;p<=o;p++){var c,f=p/o,m=this,d=n*f;0!=d&&(m=m.rotateZ(d)),l=h.times(f),m=m.translate(l),i&&(m=i(m,f,d));for(var v=m.sides[0].vertex0,g=(c=m.getOutlinePaths()[0].points).length;g>0&&c[0]!=v;g--)c.push(c.shift());m=CAG.fromPoints(c),c.push(c[0]);var y=t.z*f;if(0==p||p==o){var x=0==p;t.z<0&&(x=!x),this._addFlats(u,m,y,x)}p>0&&this._addWalls(u,s,a,c,y,t.z<0),m,s=c,a=y}return CSG.fromPolygons(u)},_VECTOR1x1:new CSG.Vector2D(1,1),_addFlats:function(e,t,n,r){var o=t.getBounds();o[0]=o[0].minus(this._VECTOR1x1),o[1]=o[1].plus(this._VECTOR1x1);var i=t.toCSG(n-1,n+1),s=CSG.fromPolygons([new CSG.Polygon([new CSG.Vertex(new CSG.Vector3D(o[0].x,o[0].y,n)),new CSG.Vertex(new CSG.Vector3D(o[1].x,o[0].y,n)),new CSG.Vertex(new CSG.Vector3D(o[1].x,o[1].y,n)),new CSG.Vertex(new CSG.Vector3D(o[0].x,o[1].y,n))])]);return r&&(s=s.inverse()),(s=s.intersect(i)).polygons.map((function(t){Math.abs(t.plane.normal.z)>.99&&e.push(t)})),e},_addWalls:function(e,t,n,r,o,i,s){for(var a,l=r.length-1,u=t.length-1,h=l-u,p=h>0,c=h<0,f=[],m=Math.abs(h);m>0;m--)f.push({len:1/0,index:-1});if(c)for(m=0;m<u;m++){a=new CAG.Side(new CAG.Vertex(t[m]),new CAG.Vertex(t[m+1])).lengthSquared();for(var d=f.length-1;d>=0;d--)if(f[d].len>a){f[d].len=a,f.index=d;break}}else if(p)for(m=0;m<l;m++){a=new CAG.Side(new CAG.Vertex(r[m]),new CAG.Vertex(r[m+1])).lengthSquared();for(d=f.length-1;d>=0;d--)if(f[d].len>a){f[d].len=a,f.index=d;break}}f.sort(fnSortByIndex);for(var v,g=function addWallsPutTriangle(e,t,n,r){var o=new CSG.Polygon([new CSG.Vertex(e),new CSG.Vertex(t),new CSG.Vertex(n)],r?new CSG.Polygon.Shared(r):null);return i?o.flipped():o},y=t[0],x=r[0],w=0,V=0,P=l+u;w+V<P;){if(f.length){if(p&&V==f[0].index){v=r[++V],e.push(g(v.toVector3D(o),x.toVector3D(o),y.toVector3D(n))),x=v,f.shift();continue}if(c&&w==f[0].index){v=t[++w],e.push(g(x.toVector3D(o),y.toVector3D(n),v.toVector3D(n))),y=v,f.shift();continue}}(w<u?new CAG.Side(new CAG.Vertex(x),new CAG.Vertex(t[w+1])).lengthSquared():1/0)<=(V<l?new CAG.Side(new CAG.Vertex(y),new CAG.Vertex(r[V+1])).lengthSquared():1/0)?(v=t[++w],e.push(g(x.toVector3D(o),y.toVector3D(n),v.toVector3D(n))),y=v):V<l&&(v=r[++V],e.push(g(v.toVector3D(o),x.toVector3D(o),y.toVector3D(n))),x=v)}return e},check:function(){var e=[];this.isSelfIntersecting()&&e.push("Self intersects");var t={};for(var n in this.sides.map((function(e){function mappoint(e){var n=e.x+" "+e.y;n in t||(t[n]=0),t[n]++}mappoint(e.vertex0.pos),mappoint(e.vertex1.pos)})),t){var r=t[n];1&r&&e.push("Uneven number of sides ("+r+") for point "+n)}var o=this.area();if(o<1e-5&&e.push("Area is "+o),e.length>0){var i="";throw e.map((function(e){i+=e+"\n"})),new Error(i)}},canonicalized:function(){if(this.isCanonicalized)return this;var e=(new CAG.fuzzyCAGFactory).getCAG(this);return e.isCanonicalized=!0,e},toCompactBinary:function(){var e=this.canonicalized(),t=e.sides.length,n={},r=[],o=0,i=new Uint32Array(2*t),s=0;e.sides.map((function(e){[e.vertex0,e.vertex1].map((function(e){var t,a=e.getTag();a in n?t=n[a]:(t=o++,n[a]=t,r.push(e)),i[s++]=t}))}));var a=new Float64Array(2*o),l=0;return r.map((function(e){var t=e.pos;a[l++]=t._x,a[l++]=t._y})),{class:"CAG",sideVertexIndices:i,vertexData:a}},getOutlinePaths:function(){var e=this.canonicalized(),t={},n={};e.sides.map((function(e){var r=e.getTag();t[r]=e;var o=e.vertex0.getTag();o in n||(n[o]=[]),n[o].push(r)}));for(var r=[];;){var o=null;for(var i in n){var s=n[i];o=s[0],s.splice(0,1),0===s.length&&delete n[i];break}if(null===o)break;for(var a=[],l=t[o],u=l.vertex0.getTag();;){a.push(l.vertex0.pos);var h=l.vertex1.getTag();if(h==u)break;if(!(h in n))throw new Error("Area is not closed!");var p=n[h],c=-1;if(1==p.length)c=0;else for(var f=null,m=l.direction().angleDegrees(),d=0;d<p.length;d++){var v=p[d],g=t[v].direction().angleDegrees()-m;g<-180&&(g+=360),g>=180&&(g-=360),(c<0||g>f)&&(c=d,f=g)}var y=p[c];p.splice(c,1),0===p.length&&delete n[h],l=t[y]}var x=new CSG.Path2D(a,!0);r.push(x)}return r},toDxf:function(){var e=this.getOutlinePaths();return CAG.PathsToDxf(e)}},CAG.PathsToDxf=function(e){var t="999\nDXF generated by OpenJsCad\n";return t+="  0\nSECTION\n  2\nHEADER\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nTABLES\n",t+="  0\nTABLE\n  2\nLTYPE\n  70\n1\n",t+="  0\nLTYPE\n  2\nCONTINUOUS\n  3\nSolid Line\n  72\n65\n  73\n0\n  40\n0.0\n",t+="  0\nENDTAB\n",t+="  0\nTABLE\n  2\nLAYER\n  70\n1\n",t+="  0\nLAYER\n  2\nOpenJsCad\n  62\n7\n  6\ncontinuous\n",t+="  0\nENDTAB\n",t+="  0\nTABLE\n  2\nSTYLE\n  70\n0\n  0\nENDTAB\n",t+="  0\nTABLE\n  2\nVIEW\n  70\n0\n  0\nENDTAB\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nBLOCKS\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nENTITIES\n",e.map((function(e){var n=e.points.length+(e.closed?1:0);t+="  0\nLWPOLYLINE\n  8\nOpenJsCad\n  90\n"+n+"\n  70\n"+(e.closed?1:0)+"\n";for(var r=0;r<n;r++){var o=r;o>=e.points.length&&(o-=e.points.length);var i=e.points[o];t+=" 10\n"+i.x+"\n 20\n"+i.y+"\n 30\n0.0\n"}})),t+="  0\nENDSEC\n  0\nEOF\n",new Blob([t],{type:"application/dxf"})},CAG.Vertex=function(e){this.pos=e},CAG.Vertex.prototype={toString:function(){return"("+this.pos.x.toFixed(2)+","+this.pos.y.toFixed(2)+")"},getTag:function(){var e=this.tag;return e||(e=CSG.getTag(),this.tag=e),e}},CAG.Side=function(e,t){if(!(e instanceof CAG.Vertex))throw new Error("Assertion failed");if(!(t instanceof CAG.Vertex))throw new Error("Assertion failed");this.vertex0=e,this.vertex1=t},CAG.Side.fromFakePolygon=function(e){if(4!=e.vertices.length)throw new Error("Assertion failed");for(var t=[],n=[],r=0;r<4;r++){var o=e.vertices[r].pos;if(o.z>=-1.001&&o.z<-.999);else if(!(o.z>=.999&&o.z<1.001))throw new Error("Assertion failed");o.z>0&&(t.push(new CSG.Vector2D(o.x,o.y)),n.push(r))}if(2!=t.length)throw new Error("Assertion failed");var i,s,a=n[1]-n[0];if(1==a)i=t[1],s=t[0];else{if(3!=a)throw new Error("Assertion failed");i=t[0],s=t[1]}return new CAG.Side(new CAG.Vertex(i),new CAG.Vertex(s))},CAG.Side.prototype={toString:function(){return this.vertex0+" -> "+this.vertex1},toPolygon3D:function(e,t){var n=[new CSG.Vertex(this.vertex0.pos.toVector3D(e)),new CSG.Vertex(this.vertex1.pos.toVector3D(e)),new CSG.Vertex(this.vertex1.pos.toVector3D(t)),new CSG.Vertex(this.vertex0.pos.toVector3D(t))];return new CSG.Polygon(n)},transform:function(e){var t=this.vertex0.pos.transform(e),n=this.vertex1.pos.transform(e);return new CAG.Side(new CAG.Vertex(t),new CAG.Vertex(n))},flipped:function(){return new CAG.Side(this.vertex1,this.vertex0)},direction:function(){return this.vertex1.pos.minus(this.vertex0.pos)},getTag:function(){var e=this.tag;return e||(e=CSG.getTag(),this.tag=e),e},lengthSquared:function(){var e=this.vertex1.pos.x-this.vertex0.pos.x,t=this.vertex1.pos.y-this.vertex0.pos.y;return e*e+t*t},length:function(){return Math.sqrt(this.lengthSquared())}},CAG.fuzzyCAGFactory=function(){this.vertexfactory=new CSG.fuzzyFactory(2,1e-5)},CAG.fuzzyCAGFactory.prototype={getVertex:function(e){var t=[e.pos._x,e.pos._y];return this.vertexfactory.lookupOrCreate(t,(function(t){return e}))},getSide:function(e){var t=this.getVertex(e.vertex0),n=this.getVertex(e.vertex1);return new CAG.Side(t,n)},getCAG:function(e){var t=this,n=e.sides.map((function(e){return t.getSide(e)}));return CAG.fromSides(n)}},CSG.addTransformationMethodsToPrototype(CSG.prototype),CSG.addTransformationMethodsToPrototype(CSG.Vector2D.prototype),CSG.addTransformationMethodsToPrototype(CSG.Vector3D.prototype),CSG.addTransformationMethodsToPrototype(CSG.Vertex.prototype),CSG.addTransformationMethodsToPrototype(CSG.Plane.prototype),CSG.addTransformationMethodsToPrototype(CSG.Polygon.prototype),CSG.addTransformationMethodsToPrototype(CSG.Line3D.prototype),CSG.addTransformationMethodsToPrototype(CSG.Connector.prototype),CSG.addTransformationMethodsToPrototype(CSG.Path2D.prototype),CSG.addTransformationMethodsToPrototype(CSG.Line2D.prototype),CSG.addTransformationMethodsToPrototype(CAG.prototype),CSG.addTransformationMethodsToPrototype(CAG.Side.prototype),CSG.Polygon2D=function(e){var t=CAG.fromPoints(e);this.sides=t.sides},CSG.Polygon2D.prototype=CAG.prototype,e.CSG=CSG,e.CAG=CAG}(this);